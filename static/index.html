<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StockEasyï½œã‚‰ãã‚‰ãå‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link href="https://fonts.googleapis.com/css2?family=Kaisei+Tokumin&family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c&display=swap" rel="stylesheet">
  <!-- Transformer.js for Local AI -->
  <script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ä½¿ç”¨ã«è¨­å®š
    env.allowRemoteModels = true;  // åˆå›ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è¨±å¯
    env.useBrowserCache = true;    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨
    
    window.transformers = { pipeline, env };
    console.log('âœ… Transformer.js loaded successfully');
  </script>
  <style>
    .tab-navigation {
      margin-bottom: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .tab-button {
      padding: 0.5rem 1rem;
      border: 2px solid #e9d5ff;
      border-radius: 8px;
      background: white;
      color: #7c3aed;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .tab-button:hover {
      background: linear-gradient(45deg, #f3f0ff, #e9d5ff);
      border-color: #a78bfa;
    }
    
    .tab-button.active {
      background: linear-gradient(45deg, #a78bfa, #c4b5fd);
      color: white;
      border-color: #8b5cf6;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: "Noto Sans JP", "Segoe UI", sans-serif;
      margin: 0;
      background: linear-gradient(to bottom right, #f3e8ff, #ede9fe);
    }

    .sub-heading {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      font-size: 1rem;
      color: #6d6f788f;
      font-weight: 500;
      margin-bottom: 1.5rem;
    }
    
    /* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .hero-section {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.1) 0%, transparent 50%);
    }
    .hero-content {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 4rem;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    .hero-text {
      color: white;
    }
    .hero-title {
      font-size: 3.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: linear-gradient(45deg, #fff, #e0e7ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-subtitle {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      opacity: 0.9;
      font-weight: 300;
    }
    .hero-description {
      font-size: 1.1rem;
      opacity: 0.8;
      line-height: 1.8;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .login-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2.5rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .login-card h3 {
      font-size: 1.5rem;
      margin-bottom: 2rem;
      color: #333;
      text-align: center;
      font-weight: 600;
    }
    
    /* æ–½è¨­é¸æŠã‚¨ãƒªã‚¢ */
    .facility-select-area {
      margin-bottom: 1.5rem;
      display: none;
    }
    
    .facility-select-area.show {
      display: block;
    }
    
    .facility-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    /* æ–½è¨­IDå…¥åŠ›ã‚¨ãƒªã‚¢ */
    .facility-id-area {
      margin-bottom: 1.5rem;
    }
    
    .facility-id-label {
      display: block;
      margin-bottom: 0.8rem;
      font-weight: 600;
      color: #374151;
      font-size: 1rem;
    }
    
    .facility-id-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      background: white;
      transition: all 0.3s ease;
    }
    
    .facility-id-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .facility-tab {
      padding: 0.5rem 1rem;
      border: 2px solid #e9d5ff;
      border-radius: 8px;
      background: white;
      color: #7c3aed;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .facility-tab:hover {
      background: linear-gradient(45deg, #f3f0ff, #e9d5ff);
      border-color: #a78bfa;
    }
    
    .facility-tab.active {
      background: linear-gradient(45deg, #a78bfa, #c4b5fd);
      color: white;
      border-color: #8b5cf6;
    }
    
    .new-facility-form {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      display: none;
    }
    
    .new-facility-form.show {
      display: block;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #374151;
    }
    
    .role-select, .facility-input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 1rem;
      margin-bottom: 1rem;
      background: white;
      transition: all 0.3s ease;
    }
    .role-select:focus, .facility-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .password-area {
      margin-bottom: 1.5rem;
      display: block;
    }
    .password-area input {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .password-area input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .login-btn, .facility-btn {
      width: 100%;
      padding: 1rem 2rem;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
    }
    .login-btn:hover, .facility-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    
    .facility-btn.secondary {
      background: linear-gradient(45deg, #6b7280, #9ca3af);
    }
    
    .facility-btn.secondary:hover {
      box-shadow: 0 10px 30px rgba(107, 114, 128, 0.4);
    }
    
    /* æ©Ÿèƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .features-section {
      padding: 6rem 0;
      background: white;
    }
    .section-title {
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 3rem;
      color: #333;
      font-weight: 700;
    }
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }
    .feature-card {
      text-align: center;
      padding: 2.5rem 1.5rem;
      background: #f8fafc;
      border-radius: 16px;
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
    }
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      background: white;
    }
    .feature-icon {
      font-size: 3rem;
      margin-bottom: 1.5rem;
    }
    .feature-card h3 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      color: #333;
      font-weight: 600;
    }
    .feature-card p {
      color: #666;
      line-height: 1.6;
    }
    
    /* åˆ©ç”¨è€…ã®å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .testimonials-section {
      padding: 6rem 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .testimonials-section .section-title {
      color: white;
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 3rem;
      font-weight: 700;
    }
    
    .testimonials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .testimonial-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 2rem;
      color: #333;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .testimonial-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
    }
    
    .testimonial-content {
      margin-bottom: 1.5rem;
    }
    
    .quote-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .testimonial-text {
      font-size: 1rem;
      line-height: 1.7;
      color: #555;
      font-style: italic;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .testimonial-author {
      border-top: 1px solid #e1e5e9;
      padding-top: 1rem;
    }
    
    .author-info h4 {
      color: #667eea;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    
    .author-info span {
      display: block;
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }
    
    .author-info .role {
      color: #8b5cf6;
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    /* åˆ©ç”¨è€…åˆ¥æ©Ÿèƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .roles-section {
      padding: 6rem 0;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    }
    .roles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 3rem;
    }
    .role-card {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .role-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    }
    .role-card h3 {
      font-size: 1.5rem;
      margin-bottom: 2rem;
      font-weight: 600;
    }
    .staff-card h3 {
      color: #10b981;
    }
    .admin-card h3 {
      color: #8b5cf6;
    }
    .role-card ul {
      list-style: none;
    }
    .role-card li {
      padding: 0.8rem 0;
      border-bottom: 1px solid #f1f5f9;
      position: relative;
      padding-left: 2rem;
    }
    .role-card li:before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: #10b981;
      font-weight: bold;
    }
    .admin-card li:before {
      color: #8b5cf6;
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .main-content {
      margin: 1rem;
      background: linear-gradient(135deg, #faf8ff 0%, #f5f3ff 100%);
      min-height: 100vh;
      padding: 1rem;
      border-radius: 20px;
    }
    
    .compact-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.08);
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
      border: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .compact-header h1 {
      font-size: 1.8rem;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      font-weight: 700;
    }
    
    .compact-header .sub-heading {
      color: #a78bfa;
      margin: 0;
      font-size: 0.85rem;
    }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    
    .admin-section {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.08);
      margin-bottom: 2rem;
      border-left: 4px solid #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .admin-section h2 {
      color: #7c3aed;
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* ç®¡ç†è€…ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .admin-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid #f3f0ff;
      padding-bottom: 0.5rem;
    }
    
    .admin-tab {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px 8px 0 0;
      background: #f8fafc;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 0.9rem;
      border-bottom: 3px solid transparent;
    }
    
    .admin-tab:hover {
      background: #f1f5f9;
      color: #374151;
    }
    
    .admin-tab.active {
      background: white;
      color: #7c3aed;
      border-bottom-color: #a78bfa;
      box-shadow: 0 -2px 8px rgba(139, 92, 246, 0.1);
    }
    
    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .admin-tab-content {
      display: none;
    }
    
    .admin-tab-content.active {
      display: block;
    }
    /* è¨­å®šãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .settings-separator {
      width: 1px;
      height: 24px;
      background: #e5e7eb;
      margin: 0 0.5rem;
    }
    
    .settings-btn {
      background: linear-gradient(45deg, #6366f1, #8b5cf6) !important;
      color: white !important;
      border: none !important;
      padding: 0.6rem 1.2rem !important;
      border-radius: 8px !important;
      font-size: 0.9rem !important;
      font-weight: 600 !important;
      display: flex !important;
      align-items: center !important;
      gap: 0.5rem !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
    }
    
    .settings-btn:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4) !important;
    }
    /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    .settings-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }
    
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #f3f0ff;
    }
    
    .settings-header h3 {
      margin: 0;
      color: #7c3aed;
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .close-btn {
      background: #f3f4f6;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    
    .close-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .settings-section {
      margin-bottom: 2rem;
    }
    
    .settings-section h4 {
      margin: 0 0 1rem 0;
      color: #374151;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
    .color-palette {
      display: flex;
      gap: 1rem;
    }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .color-option.active {
      border-color: white;
      box-shadow: 0 0 0 2px currentColor, 0 4px 15px rgba(0, 0, 0, 0.3);
      transform: scale(1.15);
    }
    
    /* è¨­å®šã‚°ãƒªãƒƒãƒ‰ */
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }
    
    .settings-item-btn {
      padding: 1rem;
      border: 2px solid #e9d5ff;
      border-radius: 12px;
      background: white;
      color: #7c3aed;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      text-align: center;
    }
    
    .settings-item-btn:hover {
      background: linear-gradient(45deg, #f3f0ff, #e9d5ff);
      border-color: #a78bfa;
      transform: translateY(-2px);
    }
    .status-available {
      color: #7c3aed;
      font-weight: 600;
      background: rgba(124, 58, 237, 0.1);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    .status-in-use {
      color: #dc2626;
      font-weight: 600;
      background: rgba(220, 38, 38, 0.1);
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    
    button {
      margin: 0.2rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 8px;
      background: linear-gradient(45deg, #a78bfa, #c4b5fd);
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    button:hover {
      transform: translateY(-1px);
      background: linear-gradient(45deg, #8b5cf6, #a78bfa);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ãƒœã‚¿ãƒ³ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰ã‚‚åŒã˜ã‚¹ã‚¿ã‚¤ãƒ« */
    .header-controls button {
      background: linear-gradient(45deg, #a78bfa, #c4b5fd);
      color: white;
    }
    .header-controls button:hover {
      background: linear-gradient(45deg, #8b5cf6, #a78bfa);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
    }
    
    .delete-button {
      background: linear-gradient(45deg, #f87171, #ef4444) !important;
    }
    .delete-button:hover {
      background: linear-gradient(45deg, #ef4444, #dc2626) !important;
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.3);
    }
    
    input, select {
      padding: 0.6rem 1rem;
      margin: 0.2rem;
      border-radius: 8px;
      border: 2px solid #e9d5ff;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      background: white;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #a78bfa;
      box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background: white;
      box-shadow: 0 8px 30px rgba(139, 92, 246, 0.08);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(139, 92, 246, 0.1);
      table-layout: fixed; /* ã‚«ãƒ©ãƒ å¹…ã‚’å›ºå®š */
    }
    th, td {
      border: 1px solid #f3f0ff;
      padding: 1rem 0.8rem;
      text-align: left;
      word-break: break-all; /* é•·ã„å˜èªã‚’æ”¹è¡Œ */
    }
    th {
      background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 0.85rem;
    }
    th:hover {
      background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
    }
    
    tbody tr {
      transition: all 0.3s ease;
    }
    
    tbody tr:hover {
      background: linear-gradient(135deg, #faf8ff 0%, #f3f0ff 100%);
      transform: scale(1.01);
    }
    
    .image-column {
      width: 130px; /* ç”»åƒã‚«ãƒ©ãƒ ã®å¹…ã‚’èª¿æ•´ */
    }
    .image-column-td {
      width: 130px; /* ç”»åƒã‚«ãƒ©ãƒ ã®ã‚»ãƒ«å¹…ã‚’èª¿æ•´ */
      text-align: center; /* ç”»åƒã‚’ä¸­å¤®æƒãˆ */
    }
    .image-preview {
      width: 120px;
      height: 120px;
      object-fit: contain; /* ç”»åƒãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã«èª¿æ•´ */
      border: 2px solid #e9d5ff;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .image-preview:hover {
      transform: scale(1.05);
      border-color: #a78bfa;
    }
    
    .image-wrapper {
      position: relative;
      display: inline-block;
      width: 100px;
      height: 100px;
    }
    
    .edit-button {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(139, 92, 246, 0.9);
      color: white;
      border: none;
      padding: 0.3rem 0.5rem;
      font-size: 0.7rem;
      border-radius: 4px;
      display: none;
      cursor: pointer;
      z-index: 2;
      font-weight: 500;
    }
    .edit-button:hover {
      background: rgba(124, 58, 237, 1);
    }
    .image-wrapper:hover .edit-button {
      display: block;
    }
    
    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      width: 300px;
    }
    .edit-modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: #333;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .storage-notice {
      background: linear-gradient(45deg, #e3f2fd, #f3e5f5);
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
      color: #1976d2;
      font-size: 0.9rem;
      text-align: center;
    }
    .button-group {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }
    
    /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .error-notice {
      background: linear-gradient(45deg, #fee2e2, #fecaca);
      border: 1px solid #f87171;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      color: #dc2626;
      text-align: center;
    }
    
    .retry-button {
      background: linear-gradient(45deg, #10b981, #34d399);
      margin-top: 0.5rem;
    }
    .retry-button:hover {
      background: linear-gradient(45deg, #059669, #10b981);
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.95);
      padding: 20px 30px;
      border-radius: 12px;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.1);
      color: #7c3aed;
      font-weight: 500;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .hero-content {
        grid-template-columns: 1fr;
        gap: 2rem;
        text-align: center;
      }
      .hero-title {
        font-size: 2.5rem;
      }
      .login-card {
        padding: 2rem;
      }
      .roles-grid {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 0 1rem;
      }
      
      .compact-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header-controls {
        width: 100%;
        justify-content: flex-start;
      }
      
      .compact-header h1 {
        font-size: 1.5rem;
      }
      
      table {
        font-size: 0.85rem;
      }
      
      th, td {
        padding: 0.5rem 0.3rem;
      }
      
      .image-preview {
        width: 60px;
        height: 60px;
      }
      
      .testimonials-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .testimonial-card {
        padding: 1.5rem;
      }
      
      .testimonials-section .section-title {
        font-size: 2rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .facility-tabs {
        flex-direction: column;
      }
    }
    /* ====================================
       StockEasy AI ãƒãƒƒã‚¸ & ãƒãƒ£ãƒƒãƒˆ UI
       ==================================== */
    
    /* AIæ­è¼‰ãƒãƒƒã‚¸ï¼ˆå³ä¸‹å›ºå®šï¼‰ - ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ã¿è¡¨ç¤º */
    .ai-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      z-index: 1000;
      font-weight: 600;
      font-size: 14px;
      display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
      align-items: center;
      gap: 8px;
      user-select: none;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¡¨ç¤º */
    .ai-badge.show {
      display: flex;
    }
    
    .ai-badge:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
      background: linear-gradient(45deg, #5a67d8, #667eea);
    }
    
    .ai-badge .ai-icon {
      font-size: 16px;
      animation: aiPulse 2s infinite;
    }
    
    @keyframes aiPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* AIçŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .ai-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: statusPulse 2s infinite;
    }
    
    .ai-status-dot.loading {
      background: #f59e0b;
    }
    
    .ai-status-dot.error {
      background: #ef4444;
      animation: none;
    }
    
    @keyframes statusPulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.2); }
    }
    
    /* AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ« */
    .ai-chat-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 380px;
      height: 500px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      border: 2px solid rgba(102, 126, 234, 0.2);
      transform: scale(0) translateY(50px);
      opacity: 0;
      visibility: hidden;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .ai-chat-panel.active {
      transform: scale(1) translateY(0);
      opacity: 1;
      visibility: visible;
    }
    
    /* AIãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ */
    .ai-chat-header {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .ai-chat-title {
      font-weight: 600;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-close-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }
    
    /* AIãƒãƒ£ãƒƒãƒˆãƒœãƒ‡ã‚£ */
    .ai-chat-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    /* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
    .ai-message {
      margin-bottom: 15px;
      animation: messageSlideIn 0.4s ease-out;
    }
    
    .ai-message.user {
      text-align: right;
    }
    
    .ai-message-bubble {
      display: inline-block;
      padding: 10px 15px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .ai-message.ai .ai-message-bubble {
      background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
      color: #4c1d95;
      border-bottom-left-radius: 6px;
    }
    
    .ai-message.user .ai-message-bubble {
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
      color: #065f46;
      border-bottom-right-radius: 6px;
    }
    
    /* AIãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ */
    .ai-chat-input {
      padding: 15px 20px;
      border-top: 1px solid #e2e8f0;
      background: white;
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    
    .ai-input-field {
      flex: 1;
      border: 2px solid #e2e8f0;
      border-radius: 20px;
      padding: 10px 15px;
      resize: none;
      font-size: 14px;
      max-height: 80px;
      min-height: 40px;
      transition: all 0.3s ease;
    }
    
    .ai-input-field:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .ai-send-btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-send-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .ai-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ›ãƒãƒ¼æ™‚ï¼‰ */
    .ai-badge:hover + .ai-preview {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .ai-preview {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 12px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.3s ease;
      z-index: 998;
      max-width: 200px;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 600px) {
      .ai-chat-panel {
        width: calc(100vw - 40px);
        height: calc(100vh - 140px);
        bottom: 20px;
        right: 20px;
      }
      
      .ai-badge {
        bottom: 15px;
        right: 15px;
        padding: 10px 16px;
        font-size: 13px;
      }
    }
    /* ç®¡ç†è€…ç”»é¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å¹…å›ºå®š */
  #adminLayout table {
    width: 100%;
    table-layout: fixed; /* é‡è¦ï¼šåˆ—å¹…ã‚’å›ºå®š */
  }

  #adminLayout th, #adminLayout td {
    white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã®æ”¹è¡Œã‚’é˜²ã */
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ç®¡ç†è€…ç”»é¢ã®åˆ—å¹…æŒ‡å®šï¼ˆç”»åƒã‚‚åºƒãï¼‰ */
  #adminLayout th:nth-child(1) { width: 80px; }   /* ç”»åƒï¼ˆåºƒãï¼‰ */
  #adminLayout th:nth-child(2) { width: 120px; }  /* å‚™å“å */
  #adminLayout th:nth-child(3) { width: 50px; }   /* ID */
  #adminLayout th:nth-child(4) { width: 80px; }   /* ä¿ç®¡å ´æ‰€ */
  #adminLayout th:nth-child(5) { width: 60px; }   /* ç¾åœ¨åœ° */
  #adminLayout th:nth-child(6) { width: 60px; }   /* ä½¿ç”¨è€… */
  #adminLayout th:nth-child(7) { width: 60px; }   /* çŠ¶æ…‹ */
  #adminLayout th:nth-child(8) { width: 80px; }   /* å‚™è€ƒ */
  #adminLayout th:nth-child(9) { width: 80px; }   /* ç¨®åˆ¥ */
  #adminLayout th:nth-child(10) { width: 250px; } /* æ“ä½œï¼ˆåºƒãï¼‰ */
    
  /* ç®¡ç†è€…ç”»é¢ã®æ“ä½œåˆ—ï¼šçµ¶å¯¾ã«è¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã« */
  #adminLayout td:nth-child(10) {
    white-space: nowrap !important;
    overflow: visible !important;
    text-overflow: clip !important;
    min-width: 200px !important;
  }

  /* ç®¡ç†è€…ç”»é¢ã®ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
  #adminLayout button {
    font-size: 0.75rem !important;
    padding: 0.3rem 0.6rem !important;
    margin: 0.1rem !important;
  }

  /* å‚™å“ååˆ—ã‚‚å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ */
  #adminLayout td:nth-child(2) {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
  }

  /* è·å“¡ç”»é¢ã®ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å¹…å›ºå®š */
  #staffLayout table {
    width: 100%;
    table-layout: fixed;
  }

  #staffLayout th, #staffLayout td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* è·å“¡ç”»é¢ã®åˆ—å¹…æŒ‡å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ */
  #staffLayout th:nth-child(1) { width: 80px; }   /* ç”»åƒ */
  #staffLayout th:nth-child(2) { width: 140px; }  /* å‚™å“åï¼ˆå°‘ã—å°ã•ãï¼‰ */
  #staffLayout th:nth-child(3) { width: 70px; }   /* ID */
  #staffLayout th:nth-child(4) { width: 100px; }  /* ä¿ç®¡å ´æ‰€ */
  #staffLayout th:nth-child(5) { width: 80px; }   /* ç¾åœ¨åœ° */
  #staffLayout th:nth-child(6) { width: 80px; }   /* ä½¿ç”¨è€… */
  #staffLayout th:nth-child(7) { width: 80px; }   /* çŠ¶æ…‹ */
  #staffLayout th:nth-child(8) { width: 120px; }  /* å‚™è€ƒ */
  #staffLayout th:nth-child(9) { width: 120px; }  /* ç¨®åˆ¥ */
  #staffLayout th:nth-child(10) { width: 140px; } /* æ“ä½œ */

  /* çŠ¶æ…‹åˆ—ã®ã€Œä½¿ç”¨ä¸­ã€ãŒç¢ºå®Ÿã«1è¡Œã§è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†èª¿æ•´ */
  .status-in-use, .status-available {
    white-space: nowrap !important;
    display: inline-block;
    min-width: 60px;
  }

  /* å‚™è€ƒæ¬„ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
  #adminLayout td input[type="text"], 
  #staffLayout td input[type="text"] {
    width: 100%;
    box-sizing: border-box;
    white-space: nowrap;
  }

  /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å¹…å¤‰å‹•é˜²æ­¢ */
  .tab-navigation {
    margin-bottom: 1rem !important;
  }
  
  /* ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼‰ */
  #loginArea {
    /* transform: scale(0.8); */
    /* transform-origin: top left; */
    /* width: 125%; */
    /* height: 125%; */
  }

  /* ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ç”»é¢å…¨ä½“ */
  #mainContent {
    /* transform: scale(0.7); */
    /* transform-origin: top left; */
    /* width: 142.86%; */
    /* height: 142.86%; */
  }
  </style>
</head>
<body>
  <!-- StockEasy AI Interface -->
  
  <!-- AIæ­è¼‰ãƒãƒƒã‚¸ï¼ˆå³ä¸‹å›ºå®šï¼‰ -->
  <div class="ai-badge" id="aiBadge" onclick="toggleAIChat()">
    <span class="ai-icon">ğŸ¤–</span>
    <span>StockEasy AI</span>
    <div class="ai-status-dot" id="aiStatusDot"></div>
  </div>
  
  <!-- ãƒ›ãƒãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="ai-preview" id="aiPreview">
    ğŸ’¬ AIå‚™å“ç®¡ç†ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ<br>
    ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒãƒ£ãƒƒãƒˆé–‹å§‹
  </div>
  
  <!-- AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ« -->
  <div class="ai-chat-panel" id="aiChatPanel">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="ai-chat-header">
      <div class="ai-chat-title">
        <span>ğŸ¤–</span>
        <span>StockEasy AI</span>
      </div>
      <button class="ai-close-btn" onclick="closeAIChat()">Ã—</button>
    </div>
    
    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="ai-chat-body" id="aiChatBody">
      <div class="ai-message ai">
        <div class="ai-message-bubble">
          ã“ã‚“ã«ã¡ã¯ï¼StockEasy AIã®Stockee(ã‚¹ãƒˆãƒƒã‚­ãƒ¼)ã§ã™ğŸ¤–<br>
          å‚™å“ç®¡ç†ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ã€‚<br>
          ãŠæ°—è»½ã«ãŠè©±ã—ãã ã•ã„ï¼
        </div>
      </div>
    </div>
    
    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="ai-chat-input">
      <textarea 
        class="ai-input-field" 
        id="aiInputField" 
        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
        rows="1"
        onkeypress="handleAIKeyPress(event)"
        oninput="autoResizeAIInput(this)"
      ></textarea>
      <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">
        â–¶
      </button>
    </div>
  </div>
  <!-- ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ -->
  <div id="loginArea" style="display: block;">
    <!-- ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="hero-section">
      <div class="hero-content">
        <div class="hero-text">
          <h1 class="hero-title">StockEasy</h1>
          <p class="hero-subtitle">æ–½è¨­å‚™å“ã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã™ã‚‹ã‚¹ãƒãƒ¼ãƒˆãªã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³</p>
          <p class="hero-description">
            å‚™å“ã®è²¸å‡ºãƒ»è¿”å´ã‹ã‚‰åœ¨åº«ç®¡ç†ã¾ã§ã€ã™ã¹ã¦ã‚’ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã€‚<br>
            ã‚·ãƒ³ãƒ—ãƒ«ãªæ“ä½œã§ã€æ–½è¨­é‹å–¶ã‚’ã‚‚ã£ã¨ã‚¹ãƒ ãƒ¼ã‚ºã«ã€ã‚‚ã£ã¨æ¥½ã—ãã€‚
          </p>
        </div>
        <div class="login-card">
          <h3>ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³</h3>
          
          <!-- æ–½è¨­IDå…¥åŠ›ã‚¨ãƒªã‚¢ -->
          <div class="facility-id-area">
            <label for="facilityId" class="facility-id-label">æ–½è¨­ID</label>
            <input 
              type="text" 
              id="facilityId" 
              class="facility-id-input" 
              placeholder="æ–½è¨­IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
              autocomplete="off"
            />
          </div>
          
          <select id="roleSelect" class="role-select">
            <option value="staff">è·å“¡ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</option>
            <option value="admin">ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³</option>
          </select>
          <div id="passwordArea" class="password-area">
            <input type="password" id="loginPassword" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
          </div>
          <button id="loginButton" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button id="skipFacilityBtn" class="facility-btn secondary" onclick="skipFacilitySelection()">å˜ä¸€æ–½è¨­ã¨ã—ã¦ç¶šè¡Œ</button>
          <div class="storage-notice">
            <strong>Ver.4.0</strong> - è¤‡æ•°æ–½è¨­å¯¾å¿œç‰ˆï¼šæ–½è¨­ã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ç®¡ç†
          </div>
        </div>
      </div>
    </section>

    <!-- æ©Ÿèƒ½ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="features-section">
      <div class="container">
        <h2 class="section-title">ä¸»ãªæ©Ÿèƒ½</h2>
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon">ğŸ¢</div>
            <h3>è¤‡æ•°æ–½è¨­å¯¾å¿œ</h3>
            <p>ã‚°ãƒ«ãƒ¼ãƒ—é‹å–¶ã®æ–½è¨­ã‚‚ã€ãã‚Œãã‚Œç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ç®¡ç†ã§å®‰å¿ƒãƒ»å®‰å…¨ã«é‹ç”¨ã§ãã¾ã™ã€‚</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">ğŸ“‹</div>
            <h3>å‚™å“ç™»éŒ²ãƒ»ç®¡ç†</h3>
            <p>è»Šã„ã™ã€æ­©è¡Œå™¨ã€ãªã©æ§˜ã€…ãªå‚™å“ã‚’å†™çœŸä»˜ãã§ç™»éŒ²ãƒ»ç®¡ç†ã§ãã¾ã™ã€‚</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">ğŸ”„</div>
            <h3>è²¸å‡ºãƒ»è¿”å´ç®¡ç†</h3>
            <p>å‚™å“ã®è²¸å‡ºçŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æŠŠæ¡ã€‚æ¨å¥¨è¿”å´å ´æ‰€ã®è¡¨ç¤ºã§åŠ¹ç‡çš„ãªé‹ç”¨ã‚’å®Ÿç¾ã€‚</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">ğŸ“</div>
            <h3>å ´æ‰€ãƒ»çŠ¶æ…‹è¿½è·¡</h3>
            <p>å„å‚™å“ã®ç¾åœ¨åœ°ã€ä½¿ç”¨çŠ¶æ³ã€å‚™è€ƒæƒ…å ±ã‚’ä¸€ç›®ã§ç¢ºèªã€‚ç´›å¤±é˜²æ­¢ã«ã‚‚åŠ¹æœçš„ã€‚</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">ğŸ‘¥</div>
            <h3>æ¨©é™ç®¡ç†</h3>
            <p>è·å“¡ç”¨ã¨ç®¡ç†è€…ç”¨ã®2ã¤ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«ã€‚æ–½è¨­ã”ã¨ã«ç‹¬ç«‹ã—ãŸèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã€‚</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon">ğŸ“Š</div>
            <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
            <p>å‚™å“ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã§ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„ä»–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºã‚‚ç°¡å˜ã€‚</p>
          </div>
        </div>
      </div>
    </section>

    <!-- åˆ©ç”¨è€…ã®å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="testimonials-section">
      <div class="container">
        <h2 class="section-title">åˆ©ç”¨è€…ã®å£°</h2>
        <div class="testimonials-grid">
          <div class="testimonial-card">
            <div class="testimonial-content">
              <div class="quote-icon">ğŸ¢</div>
              <p class="testimonial-text">
                ã€Œè¤‡æ•°ã®äº‹æ¥­æ‰€ã‚’é‹å–¶ã—ã¦ã„ã¾ã™ãŒã€æ–½è¨­ã”ã¨ã«ç‹¬ç«‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã§ãã‚‹ã®ã§ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚‚å®‰å¿ƒã§ã™ã€‚å„æ–½è¨­ã®å‚™å“çŠ¶æ³ã‚’ä¸€å…ƒçš„ã«æŠŠæ¡ã§ãã‚‹ã®ã‚‚åŠ©ã‹ã‚Šã¾ã™ã€‚ã€
              </p>
            </div>
            <div class="testimonial-author">
              <div class="author-info">
                <h4>ç”°ä¸­ ä¸€éƒ æ§˜</h4>
                <span>æ ªå¼ä¼šç¤¾ã‚±ã‚¢ã‚µãƒãƒ¼ãƒˆ</span>
                <span class="role">ä»£è¡¨å–ç· å½¹</span>
              </div>
            </div>
          </div>
          
          <div class="testimonial-card">
            <div class="testimonial-content">
              <div class="quote-icon">â­</div>
              <p class="testimonial-text">
                ã€Œä»¥å‰ã¯è»Šã„ã™ãŒã©ã“ã«ã‚ã‚‹ã‹åˆ†ã‹ã‚‰ãšã€åˆ©ç”¨è€…æ§˜ã‚’ãŠå¾…ãŸã›ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚StockEasyã®ãŠã‹ã’ã§ã€ã™ãã«å¿…è¦ãªå‚™å“ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã€
              </p>
            </div>
            <div class="testimonial-author">
              <div class="author-info">
                <h4>å±±ç”° ç”±ç¾å­ æ§˜</h4>
                <span>ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã‚»ãƒ³ã‚¿ãƒ¼ ã¿ã©ã‚Šã®ä¸˜</span>
                <span class="role">ä»‹è­·ä¸»ä»»</span>
              </div>
            </div>
          </div>
          
          <div class="testimonial-card">
            <div class="testimonial-content">
              <div class="quote-icon">âœ¨</div>
              <p class="testimonial-text">
                ã€ŒStockEasyã‚’å°å…¥ã—ã¦ã‹ã‚‰ã€å¤±ãã—ãŸãƒªãƒ¢ã‚³ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã€é€šå‹¤é›»è»Šã§å¶ç„¶åº§ã‚Œã‚‹æ—¥ãŒç¶šãã€è´”å±“ã®ãƒãƒ¼ãƒ ãŒå„ªå‹ã—ã¦å½¼å¥³ãŒã§ãã¾ã—ãŸã€‚ä¸€ç”Ÿã¤ã„ã¦ã„ãã¾ã™ã€‚ã€
              </p>
            </div>
            <div class="testimonial-author">
              <div class="author-info">
                <h4>ä½è—¤ å¥ä¸€ æ§˜</h4>
                <span>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  ã²ã¾ã‚ã‚Šè˜</span>
                <span class="role">æ–½è¨­é•·</span>
              </div>
            </div>
          </div>
          
          <div class="testimonial-card">
            <div class="testimonial-content">
              <div class="quote-icon">ğŸš€</div>
              <p class="testimonial-text">
                ã€Œå†™çœŸä»˜ãã§å‚™å“ã‚’ç™»éŒ²ã§ãã‚‹ã®ã§ã€æ–°äººè·å“¡ã§ã‚‚ã™ãã«å‚™å“ã‚’è­˜åˆ¥ã§ãã¾ã™ã€‚ç ”ä¿®æ™‚é–“ã®çŸ­ç¸®ã«ã‚‚ã¤ãªãŒã£ã¦ã„ã¾ã™ã€‚ã€
              </p>
            </div>
            <div class="testimonial-author">
              <div class="author-info">
                <h4>éˆ´æœ¨ å¤ªéƒ æ§˜</h4>
                <span>ä»‹è­·è€äººä¿å¥æ–½è¨­ å¸Œæœ›ã®é‡Œ</span>
                <span class="role">äº‹å‹™é•·</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- åˆ©ç”¨è€…åˆ¥æ©Ÿèƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="roles-section">
      <div class="container">
        <h2 class="section-title">åˆ©ç”¨è€…åˆ¥æ©Ÿèƒ½</h2>
        <div class="roles-grid">
          <div class="role-card staff-card">
            <h3>ğŸ‘¥ è·å“¡å‘ã‘æ©Ÿèƒ½</h3>
            <ul>
              <li>å‚™å“ã®è²¸å‡ºãƒ»è¿”å´æ“ä½œ</li>
              <li>å‚™å“çŠ¶æ³ã®ç¢ºèª</li>
              <li>å‚™è€ƒæƒ…å ±ã®è¿½åŠ ãƒ»ç·¨é›†</li>
              <li>ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</li>
              <li>æ–½è¨­å†…ãƒ‡ãƒ¼ã‚¿ã¸ã®å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹</li>
            </ul>
          </div>
          <div class="role-card admin-card">
            <h3>âš™ï¸ ç®¡ç†è€…å‘ã‘æ©Ÿèƒ½</h3>
            <ul>
              <li>æ–°è¦å‚™å“ã®ç™»éŒ²</li>
              <li>å‚™å“æƒ…å ±ã®ç·¨é›†ãƒ»å‰Šé™¤</li>
              <li>å‚™å“ç”»åƒã®ç®¡ç†</li>
              <li>ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</li>
              <li>æ–½è¨­è¨­å®šãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</li>
              <li>è¤‡æ•°æ–½è¨­ã®çµ±åˆç®¡ç†</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
  <div id="loading" class="loading">
    <p>ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</p>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div id="mainContent" class="main-content" style="display: none;">
    <div class="compact-header">
      <div class="logo-section">
        <div>
          <h1>StockEasy</h1>
          <p class="sub-heading" id="facilityNameDisplay">ã‚‰ãã‚‰ãå‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>
      </div>
      
     <div class="header-controls">
        <input type="text" id="searchInput" placeholder="å‚™å“åãƒ»IDãƒ»å ´æ‰€ã§æ¤œç´¢..." style="padding: 0.6rem 1rem; margin: 0.2rem; border-radius: 8px; border: 2px solid #e9d5ff; font-size: 0.9rem; background: white; min-width: 200px;" oninput="searchItems()" />
        <button onclick="exportData()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData()" />
        <button onclick="document.getElementById('importFile').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <!-- è¨­å®šãƒœã‚¿ãƒ³ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="settings-separator"></div>
        <button id="settingsBtn" onclick="openSettings()" class="settings-btn" style="display: none;">è¨­å®š</button>
      </div>

    <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="errorNotice" class="error-notice" style="display: none;">
      <p id="errorMessage">æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
      <button class="retry-button" onclick="retryConnection()">å†è©¦è¡Œ</button>
    </div>

<<<<<<< HEAD
   <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div id="adminLayout" style="display: none;">
      <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
        <!-- å·¦å´ï¼šæ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
        <div style="flex: 0 0 320px; position: sticky; top: 1rem;">
          <div class="admin-section">
            <h2>æ–°è¦ç™»éŒ²</h2>
            <div style="display: grid; grid-template-columns: 1fr; gap: 0.8rem; margin-bottom: 1rem;">
              <input type="text" id="itemName" placeholder="å‚™å“å" style="padding: 0.5rem; font-size: 0.9rem;" />
              <input type="text" id="itemId" placeholder="ID" style="padding: 0.5rem; font-size: 0.9rem;" />
              <select id="itemLocation" style="padding: 0.5rem; font-size: 0.9rem;">
                <option value="äº‹å‹™æ‰€">äº‹å‹™æ‰€</option>
                <option value="1F">1F</option>
                <option value="2F">2F</option>
                <option value="3F">3F</option>
                <option value="4F">4F</option>
                <option value="5F">5F</option>
                <option value="åœ°åŸŸäº¤æµå®¤">åœ°åŸŸäº¤æµå®¤</option>
                <option value="æ©Ÿèƒ½è¨“ç·´å®¤">æ©Ÿèƒ½è¨“ç·´å®¤</option>
              </select>
              <select id="itemCategory" style="padding: 0.5rem; font-size: 0.9rem;">
                <option value="è»Šã„ã™">è»Šã„ã™</option>
                <option value="æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼">æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼</option>
                <option value="å®¶å…·ãƒ»å®¶é›»">å®¶å…·ãƒ»å®¶é›»</option>
                <option value="ã‚¨ã‚¢ãƒãƒƒãƒˆ">ã‚¨ã‚¢ãƒãƒƒãƒˆ</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
              <input type="file" id="itemImage" accept="image/*" style="padding: 0.3rem; font-size: 0.85rem;" />
              <button onclick="registerItem()" style="padding: 0.6rem; font-size: 0.9rem;">ç™»éŒ²</button>
            </div>
          </div>
        </div>
        
        <!-- å³å´ï¼šãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div style="flex: 1;">
          <div class="tab-navigation" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="tab-button active" data-category="" onclick="filterByTab('')">å…¨ã¦</button>
            <button class="tab-button" data-category="è»Šã„ã™" onclick="filterByTab('è»Šã„ã™')">è»Šã„ã™</button>
            <button class="tab-button" data-category="æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼" onclick="filterByTab('æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼')">æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼</button>
            <button class="tab-button" data-category="å®¶å…·ãƒ»å®¶é›»" onclick="filterByTab('å®¶å…·ãƒ»å®¶é›»')">å®¶å…·ãƒ»å®¶é›»</button>
            <button class="tab-button" data-category="ã‚¨ã‚¢ãƒãƒƒãƒˆ" onclick="filterByTab('ã‚¨ã‚¢ãƒãƒƒãƒˆ')">ã‚¨ã‚¢ãƒãƒƒãƒˆ</button>
            <button class="tab-button" data-category="ãã®ä»–" onclick="filterByTab('ãã®ä»–')">ãã®ä»–</button>
          </div>

          <table style="font-size: 0.85rem;">
            <thead>
              <tr>
                <th class="image-column">ç”»åƒ</th>
                <th onclick="sortTable('name')" style="cursor: pointer;">å‚™å“å â†•</th>
                <th onclick="sortTable('id')" style="cursor: pointer; width: 80px;">ID â†•</th>
                <th onclick="sortTable('location')" style="cursor: pointer; width: 100px;">ä¿ç®¡å ´æ‰€ â†•</th>
                <th onclick="sortTable('current')" style="cursor: pointer; width: 100px;">ç¾åœ¨åœ° â†•</th>
                <th onclick="sortTable('user')" style="cursor: pointer; width: 100px;">ä½¿ç”¨è€… â†•</th>
                <th onclick="sortTable('status')" style="cursor: pointer; width: 80px;">çŠ¶æ…‹ â†•</th>
                <th style="width: 120px;">å‚™è€ƒ</th>
                <th onclick="sortTable('category')" style="cursor: pointer; width: 120px;">ç¨®åˆ¥ â†•</th>
                <th style="width: 150px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="adminItemTable"></tbody>
          </table>
        </div>
      </div>
    </div>
        
    <!-- è·å“¡ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div id="staffLayout" style="display: none;">
      <div class="tab-navigation" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="tab-button active" data-category="" onclick="filterByTab('')">å…¨ã¦</button>
        <button class="tab-button" data-category="è»Šã„ã™" onclick="filterByTab('è»Šã„ã™')">è»Šã„ã™</button>
        <button class="tab-button" data-category="æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼" onclick="filterByTab('æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼')">æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼</button>
        <button class="tab-button" data-category="å®¶å…·ãƒ»å®¶é›»" onclick="filterByTab('å®¶å…·ãƒ»å®¶é›»')">å®¶å…·ãƒ»å®¶é›»</button>
        <button class="tab-button" data-category="ã‚¨ã‚¢ãƒãƒƒãƒˆ" onclick="filterByTab('ã‚¨ã‚¢ãƒãƒƒãƒˆ')">ã‚¨ã‚¢ãƒãƒƒãƒˆ</button>
        <button class="tab-button" data-category="ãã®ä»–" onclick="filterByTab('ãã®ä»–')">ãã®ä»–</button>
      </div>

      <table style="width: 100%;">
        <thead>
          <tr>
            <th class="image-column">ç”»åƒ</th>
            <th onclick="sortTable('name')" style="cursor: pointer;">å‚™å“å â†•</th>
            <th onclick="sortTable('id')" style="cursor: pointer;">ID â†•</th>
            <th onclick="sortTable('location')" style="cursor: pointer;">ä¿ç®¡å ´æ‰€ â†•</th>
            <th onclick="sortTable('current')" style="cursor: pointer;">ç¾åœ¨åœ° â†•</th>
            <th onclick="sortTable('user')" style="cursor: pointer;">ä½¿ç”¨è€… â†•</th>
            <th onclick="sortTable('status')" style="cursor: pointer;">çŠ¶æ…‹ â†•</th>
            <th>å‚™è€ƒ</th>
            <th onclick="sortTable('category')" style="cursor: pointer;">ç¨®åˆ¥ â†•</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="staffItemTable"></tbody>
      </table>
    </div>

    <div class="modal" id="borrowModal">
      <div class="modal-content">
        <h3>å€Ÿç”¨å…ˆã‚’é¸æŠ</h3>
        <select id="borrowSelect">
          <option>äº‹å‹™æ‰€</option>
          <option>1F</option>
          <option>2F</option>
          <option>3F</option>
          <option>4F</option>
          <option>5F</option>
          <option>åœ°åŸŸäº¤æµå®¤</option>
          <option>æ©Ÿèƒ½è¨“ç·´å®¤</option>
        </select>
        <button onclick="confirmBorrow()">æ±ºå®š</button>
        <button onclick="closeBorrowModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <div class="modal" id="returnModal">
      <div class="modal-content">
        <h3>è¿”å´å ´æ‰€ã‚’é¸æŠ</h3>
        <p id="suggestedReturn"></p>
        <select id="returnSelect">
          <option>äº‹å‹™æ‰€</option>
          <option>1F</option>
          <option>2F</option>
          <option>3F</option>
          <option>4F</option>
          <option>5F</option>
          <option>åœ°åŸŸäº¤æµå®¤</option>
          <option value="æ©Ÿèƒ½è¨“ç·´å®¤">æ©Ÿèƒ½è¨“ç·´å®¤</option>
        </select>
        <button onclick="confirmReturn()">æ±ºå®š</button>
        <button onclick="closeReturnModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
=======
   <!-- ç®¡ç†è€…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div id="adminLayout" style="display: none;">
      <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
        <!-- å·¦å´ï¼šæ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
        <div style="flex: 0 0 320px; position: sticky; top: 1rem;">
          <div class="admin-section">
            <h2>æ–°è¦ç™»éŒ²</h2>
            <div style="display: grid; grid-template-columns: 1fr; gap: 0.8rem; margin-bottom: 1rem;">
              <input type="text" id="itemName" placeholder="å‚™å“å" style="padding: 0.5rem; font-size: 0.9rem;" />
              <input type="text" id="itemId" placeholder="ID" style="padding: 0.5rem; font-size: 0.9rem;" />
              <select id="itemLocation" style="padding: 0.5rem; font-size: 0.9rem;">
                <option value="äº‹å‹™æ‰€">äº‹å‹™æ‰€</option>
                <option value="1F">1F</option>
                <option value="2F">2F</option>
                <option value="3F">3F</option>
                <option value="4F">4F</option>
                <option value="5F">5F</option>
                <option value="åœ°åŸŸäº¤æµå®¤">åœ°åŸŸäº¤æµå®¤</option>
                <option value="æ©Ÿèƒ½è¨“ç·´å®¤">æ©Ÿèƒ½è¨“ç·´å®¤</option>
              </select>
              <select id="itemCategory" style="padding: 0.5rem; font-size: 0.9rem;">
                <option value="è»Šã„ã™">è»Šã„ã™</option>
                <option value="æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼">æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼</option>
                <option value="å®¶å…·ãƒ»å®¶é›»">å®¶å…·ãƒ»å®¶é›»</option>
                <option value="ã‚¨ã‚¢ãƒãƒƒãƒˆ">ã‚¨ã‚¢ãƒãƒƒãƒˆ</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </select>
              <input type="file" id="itemImage" accept="image/*" style="padding: 0.3rem; font-size: 0.85rem;" />
              <button onclick="registerItem()" style="padding: 0.6rem; font-size: 0.9rem;">ç™»éŒ²</button>
            </div>
          </div>
        </div>
        
        <!-- å³å´ï¼šãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div style="flex: 1;">
          <div class="tab-navigation" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="tab-button active" data-category="" onclick="filterByTab('')">å…¨ã¦</button>
            <button class="tab-button" data-category="è»Šã„ã™" onclick="filterByTab('è»Šã„ã™')">è»Šã„ã™</button>
            <button class="tab-button" data-category="æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼" onclick="filterByTab('æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼')">æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼</button>
            <button class="tab-button" data-category="å®¶å…·ãƒ»å®¶é›»" onclick="filterByTab('å®¶å…·ãƒ»å®¶é›»')">å®¶å…·ãƒ»å®¶é›»</button>
            <button class="tab-button" data-category="ã‚¨ã‚¢ãƒãƒƒãƒˆ" onclick="filterByTab('ã‚¨ã‚¢ãƒãƒƒãƒˆ')">ã‚¨ã‚¢ãƒãƒƒãƒˆ</button>
            <button class="tab-button" data-category="ãã®ä»–" onclick="filterByTab('ãã®ä»–')">ãã®ä»–</button>
          </div>

          <table style="font-size: 0.85rem;">
            <thead>
              <tr>
                <th style="width: 80px;">ç”»åƒ</th>
                <th onclick="sortTable('name')" style="cursor: pointer;">å‚™å“å â†•</th>
                <th onclick="sortTable('id')" style="cursor: pointer; width: 80px;">ID â†•</th>
                <th onclick="sortTable('location')" style="cursor: pointer; width: 100px;">ä¿ç®¡å ´æ‰€ â†•</th>
                <th onclick="sortTable('current')" style="cursor: pointer; width: 100px;">ç¾åœ¨åœ° â†•</th>
                <th onclick="sortTable('user')" style="cursor: pointer; width: 100px;">ä½¿ç”¨è€… â†•</th>
                <th onclick="sortTable('status')" style="cursor: pointer; width: 80px;">çŠ¶æ…‹ â†•</th>
                <th style="width: 120px;">å‚™è€ƒ</th>
                <th onclick="sortTable('category')" style="cursor: pointer; width: 120px;">ç¨®åˆ¥ â†•</th>
                <th style="width: 150px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="adminItemTable"></tbody>
          </table>
        </div>
      </div>
    </div>
        
    <!-- è·å“¡ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div id="staffLayout" style="display: none;">
      <div class="tab-navigation" style="margin-bottom: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="tab-button active" data-category="" onclick="filterByTab('')">å…¨ã¦</button>
        <button class="tab-button" data-category="è»Šã„ã™" onclick="filterByTab('è»Šã„ã™')">è»Šã„ã™</button>
        <button class="tab-button" data-category="æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼" onclick="filterByTab('æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼')">æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼</button>
        <button class="tab-button" data-category="å®¶å…·ãƒ»å®¶é›»" onclick="filterByTab('å®¶å…·ãƒ»å®¶é›»')">å®¶å…·ãƒ»å®¶é›»</button>
        <button class="tab-button" data-category="ã‚¨ã‚¢ãƒãƒƒãƒˆ" onclick="filterByTab('ã‚¨ã‚¢ãƒãƒƒãƒˆ')">ã‚¨ã‚¢ãƒãƒƒãƒˆ</button>
        <button class="tab-button" data-category="ãã®ä»–" onclick="filterByTab('ãã®ä»–')">ãã®ä»–</button>
      </div>

      <table style="width: 100%;">
        <thead>
          <tr>
            <th>ç”»åƒ</th>
            <th onclick="sortTable('name')" style="cursor: pointer;">å‚™å“å â†•</th>
            <th onclick="sortTable('id')" style="cursor: pointer;">ID â†•</th>
            <th onclick="sortTable('location')" style="cursor: pointer;">ä¿ç®¡å ´æ‰€ â†•</th>
            <th onclick="sortTable('current')" style="cursor: pointer;">ç¾åœ¨åœ° â†•</th>
            <th onclick="sortTable('user')" style="cursor: pointer;">ä½¿ç”¨è€… â†•</th>
            <th onclick="sortTable('status')" style="cursor: pointer;">çŠ¶æ…‹ â†•</th>
            <th>å‚™è€ƒ</th>
            <th onclick="sortTable('category')" style="cursor: pointer;">ç¨®åˆ¥ â†•</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="staffItemTable"></tbody>
      </table>
>>>>>>> 0e14e0bf3cd5f909628933679d522ab0fc2b5d99
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="editModal">
      <div class="edit-modal-content">
        <h3>å‚™å“æƒ…å ±ç·¨é›†</h3>
        <div class="form-group">
          <label for="editItemName">å‚™å“å</label>
          <input type="text" id="editItemName" />
        </div>
        <div class="form-group">
          <label for="editItemId">ID</label>
          <input type="text" id="editItemId" />
        </div>
        <div class="form-group">
          <label for="editItemLocation">ä¿ç®¡å ´æ‰€</label>
          <select id="editItemLocation">
            <option value="äº‹å‹™æ‰€">äº‹å‹™æ‰€</option>
            <option value="1F">1F</option>
            <option value="2F">2F</option>
            <option value="3F">3F</option>
            <option value="4F">4F</option>
            <option value="5F">5F</option>
            <option value="åœ°åŸŸäº¤æµå®¤">åœ°åŸŸäº¤æµå®¤</option>
            <option value="æ©Ÿèƒ½è¨“ç·´å®¤">æ©Ÿèƒ½è¨“ç·´å®¤</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editItemCategory">ç¨®åˆ¥</label>
          <select id="editItemCategory">
            <option value="è»Šã„ã™">è»Šã„ã™</option>
            <option value="æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼">æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼</option>
            <option value="å®¶å…·ãƒ»å®¶é›»">å®¶å…·ãƒ»å®¶é›»</option>
            <option value="ã‚¨ã‚¢ãƒãƒƒãƒˆ">ã‚¨ã‚¢ãƒãƒƒãƒˆ</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        <div class="button-group">
          <button onclick="confirmEdit()">ä¿å­˜</button>
          <button onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="delete-button" onclick="confirmDelete()">å‰Šé™¤</button>
        </div>
      </div>
    </div>

    <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="settingsModal">
      <div class="settings-modal-content">
        <div class="settings-header">
          <h3>å„ç¨®è¨­å®š</h3>
          <button class="close-btn" onclick="closeSettings()">Ã—</button>
        </div>
        
        <!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ -->
        <div class="settings-section">
          <h4>ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</h4>
          <div class="color-palette">
            <div class="color-option active" data-color="#667eea" style="background: #667eea;" onclick="changeThemeColor('#667eea')"></div>
            <div class="color-option" data-color="#10b981" style="background: #10b981;" onclick="changeThemeColor('#10b981')"></div>
            <div class="color-option" data-color="#f59e0b" style="background: #f59e0b;" onclick="changeThemeColor('#f59e0b')"></div>
            <div class="color-option" data-color="#ef4444" style="background: #ef4444;" onclick="changeThemeColor('#ef4444')"></div>
            <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6;" onclick="changeThemeColor('#8b5cf6')"></div>
          </div>
        </div>
        
        <!-- ãã®ä»–è¨­å®šãƒœã‚¿ãƒ³ -->
        <div class="settings-section">
          <h4>è©³ç´°è¨­å®š</h4>
          <div class="settings-grid">
            <button onclick="openLocationSettings()" class="settings-item-btn">ğŸ“ ä¿ç®¡å ´æ‰€ç·¨é›†</button>
            <button onclick="openCategorySettings()" class="settings-item-btn">ğŸ“‹ ç¨®åˆ¥ç·¨é›†</button>
            <button onclick="openDisplaySettings()" class="settings-item-btn">ğŸ“Š è¡¨ç¤ºè¨­å®š</button>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="editImageInput" accept="image/*" style="display:none" />
  </div>

  <script>
    let items = [];
    let currentIndex = null;
    let isAdmin = false;
    let editingIndex = null;
    let connectionRetries = 0;
    const maxRetries = 3;
    let sortColumn = '';
    let sortDirection = 'asc';
    let currentFacilityId = null;
    let facilities = [];

    // æ–½è¨­ID â†’ æ–½è¨­åã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const facilityMap = {
      'midorinooksa': 'ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ ã¿ã©ã‚Šã®ä¸˜',
      'himawari': 'ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ  ã²ã¾ã‚ã‚Šè˜', 
      'kibounosato': 'ç‰¹é¤Š å¸Œæœ›ã®é‡Œ',
      'demo': 'ãƒ‡ãƒ¢æ–½è¨­',
      'test': 'ãƒ†ã‚¹ãƒˆæ–½è¨­'
    };
    
    // API URLã‚’å‹•çš„ã«è¨­å®š
    const USE_LOCAL_STORAGE = false; // æœ¬ç•ªç”¨ï¼ˆã‚µãƒ¼ãƒãƒ¼ä¿å­˜ï¼‰
    const API_BASE = window.location.origin + '/api';
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
    const DEBUG = true;
    function debugLog(...args) {
      if (DEBUG) console.log('[StockEasy]', ...args);
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const errorNotice = document.getElementById('errorNotice');
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = message;
      errorNotice.style.display = 'block';
    }

    function hideError() {
      document.getElementById('errorNotice').style.display = 'none';
    }

    // æ¥ç¶šå†è©¦è¡Œ
    async function retryConnection() {
      hideError();
      if (connectionRetries < maxRetries) {
        connectionRetries++;
        console.log(`æ¥ç¶šå†è©¦è¡Œ ${connectionRetries}/${maxRetries}`);
        await loadItems();
        renderItems();
      } else {
        showError('æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    // APIå‘¼ã³å‡ºã—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    async function apiCall(url, options = {}) {
      showLoading();
      try {
        console.log('APIå‘¼ã³å‡ºã—:', url);
        
        const response = await fetch(url, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          credentials: 'include', // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å«ã‚ã‚‹
          timeout: 10000, // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          ...options
        });
        
        console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹çŠ¶æ…‹:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('APIã‚¨ãƒ©ãƒ¼è©³ç´°:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('å–å¾—ãƒ‡ãƒ¼ã‚¿:', data);
        hideError();
        connectionRetries = 0;
        return data;
      } catch (error) {
        console.error('API Error:', error);
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          showError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“');
        } else {
          showError(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
        throw error;
      } finally {
        hideLoading();
      }
    }

    // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆæ–½è¨­å¯¾å¿œç‰ˆï¼‰
    async function loadItems() {
      try {
        if (!isLoggedIn()) {
          console.log('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚’ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }
        
        console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
        let url = `${API_BASE}/equipment`;
        
        // æ–½è¨­IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ 
        if (currentFacilityId) {
          url += `?facility_id=${currentFacilityId}`;
        }
        
        items = await apiCall(url);
        console.log(`${items.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
        hideError();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        items = [];
        if (connectionRetries < maxRetries) {
          showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
        }
      }
    }
    
    // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
    function isLoggedIn() {
      return document.getElementById('mainContent').style.display === 'block';
    }

    // ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    async function exportData() {
      try {
        let url = `${API_BASE}/export`;
        if (currentFacilityId) {
          url += `?facility_id=${currentFacilityId}`;
        }
        
        const data = await apiCall(url);
        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url2 = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url2;
        
        const facilityName = getCurrentFacilityName();
        const filename = facilityName ? 
          `equipment_data_${facilityName}.json` : 
          'equipment_data.json';
        
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url2);
      } catch (error) {
        console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function importData() {
      const file = document.getElementById('importFile').files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ')) {
            let url = `${API_BASE}/import`;
            const body = { data: importedData };
            
            if (currentFacilityId) {
              body.facility_id = currentFacilityId;
            }
            
            await apiCall(url, {
              method: 'POST',
              body: JSON.stringify(body)
            });
            
            await loadItems();
            renderItems();
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
          }
        } catch (error) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };
      reader.readAsText(file);
    }

    // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
    function sortTable(column) {
      // åŒã˜åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ã€ã‚½ãƒ¼ãƒˆæ–¹å‘ã‚’åè»¢
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      // ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚½ãƒ¼ãƒˆ
      items.sort((a, b) => {
        let aValue = a[column] || '';
        let bValue = b[column] || '';
        
        // æ•°å€¤ã¨ã—ã¦æ¯”è¼ƒã§ãã‚‹å ´åˆã¯æ•°å€¤æ¯”è¼ƒ
        if (!isNaN(aValue) && !isNaN(bValue) && aValue !== '' && bValue !== '') {
          aValue = parseFloat(aValue);
          bValue = parseFloat(bValue);
        } else {
          // æ–‡å­—åˆ—ã¨ã—ã¦æ¯”è¼ƒï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’ç„¡è¦–ï¼‰
          aValue = aValue.toString().toLowerCase();
          bValue = bValue.toString().toLowerCase();
        }
        
        if (sortDirection === 'asc') {
          return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
        } else {
          return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
        }
      });
      
      // æ¤œç´¢çª“ã®å†…å®¹ã‚’å–å¾—ã—ã¦å†æç”»
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      renderItems('', searchTerm);
    }

    // æ¤œç´¢æ©Ÿèƒ½
    function searchItems() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      renderItems('', searchTerm);
    }

    function renderItems(filterCategory = '', searchTerm = '') {
    // ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
    let tbody;
    if (isAdmin) {
        tbody = document.getElementById('adminItemTable'); // âœ… ç®¡ç†è€…å°‚ç”¨
    } else {
        tbody = document.getElementById('staffItemTable');  // âœ… è·å“¡å°‚ç”¨
    }
    
    if (!tbody) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'isAdmin:', isAdmin);
        return;
    }
    
    tbody.innerHTML = '';
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨æ¤œç´¢
    let filteredItems = items;
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿
    if (filterCategory) {
        filteredItems = filteredItems.filter(item => item.category === filterCategory);
    }
    
    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
    if (searchTerm) {
        filteredItems = filteredItems.filter(item => 
            (item.name && item.name.toLowerCase().includes(searchTerm)) ||
            (item.id && item.id.toLowerCase().includes(searchTerm)) ||
            (item.location && item.location.toLowerCase().includes(searchTerm)) ||
            (item.current && item.current.toLowerCase().includes(searchTerm)) ||
            (item.user && item.user.toLowerCase().includes(searchTerm))
        );
    }
    
    if (filteredItems.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td colspan="10" style="text-align: center; padding: 2rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>';
        tbody.appendChild(tr);
        return;
    }
    
    filteredItems.forEach((item, originalIndex) => {
        // å…ƒã®é…åˆ—ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        const actualIndex = items.findIndex(i => i.id === item.id);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
<<<<<<< HEAD
          <td class="image-column-td">
            <div class="image-wrapper">
              <img src="${item.image || ''}" class="image-preview" onerror="this.style.display='none'" />
              ${isAdmin ? `<button class="edit-button" onclick="editImage(${actualIndex})">ç·¨é›†</button>` : ''}
            </div>
          </td>
          <td>${item.name || ''}</td>
          <td>${item.id || ''}</td>
          <td>${item.location || ''}</td>
          <td>${item.current || ''}</td>
          <td>${item.user || ''}</td>
          <td>
            <span class="${item.status === 'å¾…æ©Ÿ' ? 'status-available' : 'status-in-use'}">
              ${item.status || 'å¾…æ©Ÿ'}
            </span>
          </td>
          <td><input type="text" value="${item.note || ''}" onchange="updateNote(${actualIndex}, this.value)" /></td>
          <td>${item.category || ''}</td>
          <td>
            <button onclick="openBorrow(${actualIndex})">å€Ÿç”¨</button>
            <button onclick="openReturn(${actualIndex})">è¿”å´</button>
            ${isAdmin ? `<button onclick="openEdit(${actualIndex})">ç·¨é›†</button>` : ''}
          </td>
=======
            <td>
                <div class="image-wrapper">
                    <img src="${item.image || ''}" class="image-preview" onerror="this.style.display='none'" />
                    ${isAdmin ? `<button class="edit-button" onclick="editImage(${actualIndex})">ç·¨é›†</button>` : ''}
                </div>
            </td>
            <td>${item.name || ''}</td>
            <td>${item.id || ''}</td>
            <td>${item.location || ''}</td>
            <td>${item.current || ''}</td>
            <td>${item.user || ''}</td>
            <td>
                <span class="${item.status === 'å¾…æ©Ÿ' ? 'status-available' : 'status-in-use'}">
                    ${item.status || 'å¾…æ©Ÿ'}
                </span>
            </td>
            <td><input type="text" value="${item.note || ''}" onchange="updateNote(${actualIndex}, this.value)" /></td>
            <td>${item.category || ''}</td>
            <td>
                <button onclick="openBorrow(${actualIndex})">å€Ÿç”¨</button>
                <button onclick="openReturn(${actualIndex})">è¿”å´</button>
                ${isAdmin ? `<button onclick="openEdit(${actualIndex})">ç·¨é›†</button>` : ''}
            </td>
>>>>>>> 0e14e0bf3cd5f909628933679d522ab0fc2b5d99
        `;
        tbody.appendChild(tr);
    });
}

    // å‚™è€ƒæ›´æ–°
    async function updateNote(index, note) {
      try {
        const item = items[index];
        const body = { note };
        
        if (currentFacilityId) {
          body.facility_id = currentFacilityId;
        }
        
        await apiCall(`${API_BASE}/equipment/${item.id}`, {
          method: 'PUT',
          body: JSON.stringify(body)
        });
        items[index].note = note;
      } catch (error) {
        console.error('å‚™è€ƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('å‚™è€ƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ç”»åƒã‚’åœ§ç¸®ã™ã‚‹é–¢æ•°
    function compressImage(file, maxWidth = 300, quality = 0.7) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = () => {
          const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(compressedDataUrl);
        };
        
        img.src = URL.createObjectURL(file);
      });
    }

    async function registerItem() {
      const name = document.getElementById('itemName').value;
      const id = document.getElementById('itemId').value;
      const location = document.getElementById('itemLocation').value;
      const category = document.getElementById('itemCategory').value;
      const imageFile = document.getElementById('itemImage').files[0];

      if (!name || !id || !location) {
        alert('å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const item = {
        name: name,
        id: id,
        location: location,
        category: category,
        history: []
      };

      if (currentFacilityId) {
        item.facility_id = currentFacilityId;
      }

      if (imageFile) {
        try {
          console.log('ç”»åƒã‚’åœ§ç¸®ä¸­...');
          const compressedImage = await compressImage(imageFile, 300, 0.6);
          console.log(`åœ§ç¸®å®Œäº†: ${compressedImage.length} æ–‡å­—`);
          
          item.image = compressedImage;
          
          await apiCall(`${API_BASE}/equipment`, {
            method: 'POST',
            body: JSON.stringify(item)
          });
          await loadItems();
          renderItems();
          clearForm();
          alert('å‚™å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆç”»åƒåœ§ç¸®æ¸ˆã¿ï¼‰');
        } catch (error) {
          console.error('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
          alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
      } else {
        try {
          await apiCall(`${API_BASE}/equipment`, {
            method: 'POST',
            body: JSON.stringify(item)
          });
          await loadItems();
          renderItems();
          clearForm();
          alert('å‚™å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        } catch (error) {
          console.error('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
          alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
      }
    }

    function clearForm() {
      document.getElementById('itemName').value = '';
      document.getElementById('itemId').value = '';
      document.getElementById('itemLocation').value = 'äº‹å‹™æ‰€';
      document.getElementById('itemCategory').value = 'è»Šã„ã™';
      document.getElementById('itemImage').value = '';
    }

    async function editImage(index) {
      const input = document.getElementById('editImageInput');
      input.onchange = async () => {
        const file = input.files[0];
        if (file) {
          try {
            console.log('ç”»åƒã‚’åœ§ç¸®ä¸­...');
            const compressedImage = await compressImage(file, 300, 0.6);
            console.log(`åœ§ç¸®å®Œäº†: ${compressedImage.length} æ–‡å­—`);
            
            const item = items[index];
            const body = { image: compressedImage };
            
            if (currentFacilityId) {
              body.facility_id = currentFacilityId;
            }
            
            await apiCall(`${API_BASE}/equipment/${item.id}`, {
              method: 'PUT',
              body: JSON.stringify(body)
            });
            items[index].image = compressedImage;
            renderItems();
            alert('ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆåœ§ç¸®æ¸ˆã¿ï¼‰');
          } catch (error) {
            console.error('ç”»åƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            alert('ç”»åƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          try {
            const item = items[index];
            const body = { image: '' };
            
            if (currentFacilityId) {
              body.facility_id = currentFacilityId;
            }
            
            await apiCall(`${API_BASE}/equipment/${item.id}`, {
              method: 'PUT',
              body: JSON.stringify(body)
            });
            delete items[index].image;
            renderItems();
            alert('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          } catch (error) {
            console.error('ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            alert('ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        }
      };
      input.click();
    }

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®é–¢æ•°
    function openEdit(index) {
      editingIndex = index;
      const item = items[index];
      
      document.getElementById('editItemName').value = item.name || '';
      document.getElementById('editItemId').value = item.id || '';
      document.getElementById('editItemLocation').value = item.location || '';
      document.getElementById('editItemCategory').value = item.category || '';
      
      document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      editingIndex = null;
    }

    async function confirmEdit() {
      if (editingIndex === null) return;
      
      const name = document.getElementById('editItemName').value;
      const newId = document.getElementById('editItemId').value;
      const location = document.getElementById('editItemLocation').value;
      const category = document.getElementById('editItemCategory').value;

      if (!newId || !location) {
        alert('IDã¨ä¿ç®¡å ´æ‰€ã¯å¿…é ˆã§ã™');
        return;
      }

      try {
        const oldItem = items[editingIndex];
        const body = { name, location, category };
        
        if (currentFacilityId) {
          body.facility_id = currentFacilityId;
        }
        
        const response = await fetch(`${API_BASE}/equipment/${oldItem.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        
        const result = await response.json();
        
        if (!result.success) {
          alert(result.message);
          return;
        }
        
        if (oldItem.id !== newId) {
          alert('IDã®å¤‰æ›´ã¯ç¾åœ¨ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
          closeEditModal();
          return;
        }

        await loadItems();
        renderItems();
        closeEditModal();
        alert('å‚™å“æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    async function confirmDelete() {
      if (editingIndex === null) return;
      
      if (confirm(`å‚™å“ã€Œ${items[editingIndex].name}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        try {
          const item = items[editingIndex];
          let url = `${API_BASE}/equipment/${item.id}`;
          
          if (currentFacilityId) {
            url += `?facility_id=${currentFacilityId}`;
          }
          
          await apiCall(url, {
            method: 'DELETE'
          });
          await loadItems();
          renderItems();
          closeEditModal();
          alert('å‚™å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        } catch (error) {
          console.error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
    }

    function openBorrow(index) {
      currentIndex = index;
      document.getElementById('borrowModal').style.display = 'flex';
    }

    function closeBorrowModal() {
      document.getElementById('borrowModal').style.display = 'none';
    }

    async function confirmBorrow() {
      const place = document.getElementById('borrowSelect').value;
      const timestamp = new Date().toLocaleString('ja-JP');
      
      try {
        const item = items[currentIndex];
        const newHistory = [...(item.history || []), { 
          action: 'å€Ÿç”¨', 
          place: place, 
          timestamp: timestamp 
        }];

        const body = {
          user: place,
          current: place,
          status: 'ä½¿ç”¨ä¸­',
          history: newHistory
        };
        
        if (currentFacilityId) {
          body.facility_id = currentFacilityId;
        }

        await apiCall(`${API_BASE}/equipment/${item.id}`, {
          method: 'PUT',
          body: JSON.stringify(body)
        });

        items[currentIndex].user = place;
        items[currentIndex].current = place;
        items[currentIndex].status = 'ä½¿ç”¨ä¸­';
        items[currentIndex].history = newHistory;
        
        renderItems();
        closeBorrowModal();
        alert('å€Ÿç”¨å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('å€Ÿç”¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('å€Ÿç”¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function openReturn(index) {
      // çŠ¶æ…‹ãŒã€Œå¾…æ©Ÿã€ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      if (items[index].status === 'å¾…æ©Ÿ') {
        alert('ã“ã®å‚™å“ã¯ç¾åœ¨è²¸ã—å‡ºã—ã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      currentIndex = index;
      const location = items[index].location;
      document.getElementById('suggestedReturn').textContent = `æ¨å¥¨è¿”å´å ´æ‰€ï¼š${location}`;
      document.getElementById('returnModal').style.display = 'flex';
    }

    function closeReturnModal() {
      document.getElementById('returnModal').style.display = 'none';
    }

    async function confirmReturn() {
      const place = document.getElementById('returnSelect').value;
      const timestamp = new Date().toLocaleString('ja-JP');
      
      try {
        const item = items[currentIndex];
        const newHistory = [...(item.history || []), { 
          action: 'è¿”å´', 
          place: place, 
          timestamp: timestamp 
        }];

        const body = {
          user: '',
          current: place,
          status: 'å¾…æ©Ÿ',
          history: newHistory
        };
        
        if (currentFacilityId) {
          body.facility_id = currentFacilityId;
        }

        await apiCall(`${API_BASE}/equipment/${item.id}`, {
          method: 'PUT',
          body: JSON.stringify(body)
        });

        items[currentIndex].user = '';
        items[currentIndex].current = place;
        items[currentIndex].status = 'å¾…æ©Ÿ';
        items[currentIndex].history = newHistory;
        
        renderItems();
        closeReturnModal();
        alert('è¿”å´å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('è¿”å´å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('è¿”å´å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function login() {
      try {
        debugLog('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†é–‹å§‹');
        
        const role = document.getElementById('roleSelect').value;
        const password = document.getElementById('loginPassword').value;
        const facilityId = document.getElementById('facilityId').value.trim();
        
        debugLog('é¸æŠã•ã‚ŒãŸå½¹å‰²:', role);
        debugLog('å…¥åŠ›ã•ã‚ŒãŸæ–½è¨­ID:', facilityId);
        
        // å…¥åŠ›å€¤æ¤œè¨¼
        if (!facilityId) {
          alert('æ–½è¨­IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        // æ–½è¨­IDã®å­˜åœ¨ç¢ºèª
        if (!facilityMap[facilityId]) {
          alert('å­˜åœ¨ã—ãªã„æ–½è¨­IDã§ã™ã€‚æ­£ã—ã„æ–½è¨­IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¿…é ˆï¼ˆè·å“¡ãƒ»ç®¡ç†è€…å…±é€šï¼‰
        if (!password) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        // æ–½è¨­IDã‚’è¨­å®š
        currentFacilityId = facilityId;

        if (role === 'admin') {
          const body = {
            username: 'admin',
            password: password
          };
          
          if (currentFacilityId) {
            body.facility_id = currentFacilityId;
          }
          
          const response = await fetch('/api/admin/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(body)
          });
          
          const result = await response.json();
          
          if (!result.success) {
            alert(result.message);
            return;
          }
        } else {
          // è·å“¡ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
          const body = {};
          
          if (currentFacilityId) {
            body.facility_id = currentFacilityId;
          }
          
          const response = await fetch('/api/staff/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(body)
          });
          
          debugLog('è·å“¡ãƒ­ã‚°ã‚¤ãƒ³APIãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡');
          const result = await response.json();
          debugLog('è·å“¡ãƒ­ã‚°ã‚¤ãƒ³çµæœ:', result);
  
          if (!result.success) {
            alert(result.message);
            return;
          }
        }
        
        debugLog('èªè¨¼æˆåŠŸã€ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–‹å§‹');
        
        // ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('loginArea').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        isAdmin = role === 'admin';
        
        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆ
        const adminLayout = document.getElementById('adminLayout');
        const staffLayout = document.getElementById('staffLayout');
        const adminRegistrationForm = document.getElementById('adminRegistrationForm');
        const settingsBtn = document.getElementById('settingsBtn');
        
        if (adminLayout) adminLayout.style.display = isAdmin ? 'block' : 'none';
        if (staffLayout) staffLayout.style.display = isAdmin ? 'none' : 'block';
        
        if (adminRegistrationForm) adminRegistrationForm.style.display = isAdmin ? 'block' : 'none';
        if (settingsBtn) settingsBtn.style.display = isAdmin ? 'flex' : 'none';
        
        // AIãƒãƒƒã‚¸ã‚’è¡¨ç¤º
        showAIBadge();
        
        // æ–½è¨­åã‚’è¡¨ç¤º
        const facilityName = facilityMap[currentFacilityId];
        if (facilityName) {
          document.getElementById('facilityNameDisplay').textContent = `${facilityName} - ã‚‰ãã‚‰ãå‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ `;
        }
        
        debugLog('ç”»é¢åˆ‡ã‚Šæ›¿ãˆå®Œäº†ã€ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
        
        // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        try {
          await loadItems();
          renderItems();
          debugLog('ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†');
        } catch (error) {
          console.error('ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
          // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã‚‚ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¯ç¶­æŒ
          renderItems(); // ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
          showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
        }
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    function logout() {
      // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¦æ±‚ã‚’é€ä¿¡
      fetch('/api/logout', {
        method: 'POST',
        credentials: 'include'
      }).catch(error => {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆè¦æ±‚ã‚¨ãƒ©ãƒ¼:', error);
      });
      
      // ç”»é¢ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('loginArea').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      hideError();
      items = [];
      isAdmin = false;
      connectionRetries = 0;
      currentFacilityId = null;

      // AIãƒãƒƒã‚¸ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      hideAIBadge();
      
      // AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚‚é–‰ã˜ã‚‹
      if (isAIChatOpen) {
        closeAIChat();
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('roleSelect').value = 'staff';
      document.getElementById('loginPassword').value = '';
      document.getElementById('facilityId').value = '';
    }
    // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    function openSettings() {
      document.getElementById('settingsModal').style.display = 'flex';
      console.log('è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
    }
    
    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
      console.log('è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
    }
    
    // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼å¤‰æ›´
    function changeThemeColor(color) {
      // å…¨ã¦ã®è‰²ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('active');
      });
      
      // é¸æŠã•ã‚ŒãŸè‰²ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      document.querySelector(`[data-color="${color}"]`).classList.add('active');
      
      // CSSå¤‰æ•°ã‚’æ›´æ–°ï¼ˆå®Ÿéš›ã®ãƒ†ãƒ¼ãƒå¤‰æ›´ã¯å¾Œã§å®Ÿè£…ï¼‰
      console.log(`ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’ ${color} ã«å¤‰æ›´`);
      
      // TODO: å®Ÿéš›ã®ãƒ†ãƒ¼ãƒé©ç”¨å‡¦ç†
    }
    
    // è©³ç´°è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
    function openLocationSettings() {
      alert('ä¿ç®¡å ´æ‰€ç·¨é›†ç”»é¢ï¼ˆæº–å‚™ä¸­ï¼‰');
    }
    
    function openCategorySettings() {
      alert('ç¨®åˆ¥ç·¨é›†ç”»é¢ï¼ˆæº–å‚™ä¸­ï¼‰');
    }
    
    function openDisplaySettings() {
      alert('è¡¨ç¤ºè¨­å®šç”»é¢ï¼ˆæº–å‚™ä¸­ï¼‰');
    }
    
    // å½¹å‰²é¸æŠã®å¤‰æ›´ã«å¿œã˜ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º/éè¡¨ç¤º
    function handleRoleChange() {
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã¯å¸¸ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ã“ã®é–¢æ•°ã¯ç©ºã«
      // å°†æ¥çš„ã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã“ã“ã§å®Ÿè£…
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹å‡¦ç†ï¼ˆèƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ï¼‰
    function setupModalEvents() {
      // å„ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.getElementById('borrowModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeBorrowModal();
        }
      });

      document.getElementById('returnModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeReturnModal();
        }
      });

      document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeEditModal();
        }
      });
    }

    // ç®¡ç†è€…ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchAdminTab(tabName) {
      // å…¨ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // å…¨ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
      document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
      document.getElementById(`${tabName}Tab`).classList.add('active');
      
      console.log(`ç®¡ç†è€…ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ: ${tabName}`);
    }

    function setupTabEvents() {
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          const category = button.dataset.category;
          filterByTab(category);
        });
      }); 
    }

    function filterByTab(category) {
      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === category) {
          btn.classList.add('active');
        }
      });
      
      // æ¤œç´¢çª“ã®å†…å®¹ã‚’å–å¾—
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      // çµã‚Šè¾¼ã¿è¡¨ç¤ºï¼ˆæ¤œç´¢ã‚‚è€ƒæ…®ï¼‰
      renderItems(category, searchTerm);
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹å¾©å…ƒé–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
async function checkAndRestoreSession() {
  try {
    debugLog('ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
    
    const response = await fetch('/api/session/check', {
      credentials: 'include'
    });
    
    if (!response.ok) {
      console.warn('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªAPIã‚¨ãƒ©ãƒ¼:', response.status);
      return; // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶™ç¶š
    }
    
    const result = await response.json();
    
    if (result.success && result.logged_in) {
      debugLog('âœ… æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œå‡ºã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å¾©å…ƒ');
      
      // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å¾©å…ƒ
      document.getElementById('loginArea').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ç”»é¢ã‚’è¨­å®š
      isAdmin = result.user_type === 'admin';
      
      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆ
      const adminLayout = document.getElementById('adminLayout');
      const staffLayout = document.getElementById('staffLayout');
      
      if (isAdmin) {
        if (adminLayout) adminLayout.style.display = 'block';
        if (staffLayout) staffLayout.style.display = 'none';
        // è¨­å®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        const settingsBtn = document.getElementById('settingsBtn');
        if (settingsBtn) settingsBtn.style.display = 'flex';
      } else {
        if (adminLayout) adminLayout.style.display = 'none';
        if (staffLayout) staffLayout.style.display = 'block';
      }
      
      // æ–½è¨­IDãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¾©å…ƒ
      if (result.facility_id) {
        currentFacilityId = result.facility_id;
        const facilityName = getCurrentFacilityName();
        if (facilityName) {
          const facilityDisplay = document.getElementById('facilityNameDisplay');
          if (facilityDisplay) {
            facilityDisplay.textContent = `${facilityName} - ã‚‰ãã‚‰ãå‚™å“ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ `;
          }
        }
      }
      
      // AIãƒãƒƒã‚¸ã‚’è¡¨ç¤º
      showAIBadge();
      
      // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚ç¶™ç¶šï¼‰
      try {
        await loadItems();
        renderItems();
        debugLog('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
      } catch (dataError) {
        console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒã¯æˆåŠŸï¼‰:', dataError);
        renderItems(); // ç©ºã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¡¨ç¤º
      }
      
    } else {
      debugLog('â„¹ï¸ æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º');
    }
    
  } catch (error) {
    console.warn('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¢ãƒ—ãƒªã¯æ­£å¸¸å‹•ä½œï¼‰:', error);
    debugLog('ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸãŒã€æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ã¯å¯èƒ½ã§ã™');
  }
}

    // åˆæœŸåŒ–å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆï¼‰
function initializeApp() {
  debugLog('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
  
  try {
    // é‡è¦ãªè¦ç´ ã®å­˜åœ¨ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãšã«è­¦å‘Šã®ã¿ï¼‰
    const loginButton = document.getElementById('loginButton');
    const roleSelect = document.getElementById('roleSelect');
    
    if (!loginButton) {
      console.warn('âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆDOMèª­ã¿è¾¼ã¿ä¸­ã®å¯èƒ½æ€§ï¼‰');
      // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹ä»£ã‚ã‚Šã«ã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
      setTimeout(() => {
        console.log('ğŸ”„ è¦ç´ ã®å†å–å¾—ã‚’è©¦è¡Œä¸­...');
        initializeApp();
      }, 500);
      return; // ã“ã“ã§å‡¦ç†ã‚’ä¸­æ–­ï¼ˆã‚¨ãƒ©ãƒ¼ã¯æŠ•ã’ãªã„ï¼‰
    }
    
    if (!roleSelect) {
      console.warn('âš ï¸ å½¹å‰²é¸æŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆDOMèª­ã¿è¾¼ã¿ä¸­ã®å¯èƒ½æ€§ï¼‰');
      setTimeout(() => {
        console.log('ğŸ”„ è¦ç´ ã®å†å–å¾—ã‚’è©¦è¡Œä¸­...');
        initializeApp();
      }, 500);
      return;
    }
    
    debugLog('âœ… å¿…è¦ãªè¦ç´ ã‚’ç¢ºèªã—ã¾ã—ãŸ');
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¨ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã®ä¸¡æ–¹ã«å¯¾å¿œ
    loginButton.addEventListener('click', function(e) {
      e.preventDefault();
      login();
    });
    
    // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ
    loginButton.addEventListener('touchstart', function(e) {
      e.preventDefault();
      login();
    });
    
    debugLog('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');
    
    roleSelect.addEventListener('change', handleRoleChange);
    debugLog('âœ… å½¹å‰²é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
    setupModalEvents();
    
    // ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
    setupTabEvents();
    
    // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    const loginPassword = document.getElementById('loginPassword');
    if (loginPassword) {
      loginPassword.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          login();
        }
      });
      debugLog('âœ… Enterã‚­ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨­å®š');
    }
    
    debugLog('âœ… åŸºæœ¬æ©Ÿèƒ½ã®åˆæœŸåŒ–å®Œäº†');
    
    // AIæ©Ÿèƒ½ã®åˆæœŸåŒ–ï¼ˆåŸºæœ¬æ©Ÿèƒ½å®Œäº†å¾Œï¼‰
    try {
      // AIé–¢é€£ã‚¯ãƒ©ã‚¹ãŒå…¨ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof IntentAnalyzer !== 'undefined' && 
          typeof ResponseGenerator !== 'undefined' && 
          typeof StockEasyAI !== 'undefined') {
        
        stockEasyAI = new StockEasyAI();
        debugLog('âœ… AIæ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
      } else {
        console.warn('âš ï¸ AIé–¢é€£ã‚¯ãƒ©ã‚¹ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
        // AIæ©Ÿèƒ½ãªã—ã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«
        stockEasyAI = null;
        debugLog('âš ï¸ AIæ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã¯æ­£å¸¸å‹•ä½œï¼‰');
      }
    } catch (aiError) {
      console.warn('âš ï¸ AIæ©Ÿèƒ½ã®åˆæœŸåŒ–ã«å¤±æ•—:', aiError);
      stockEasyAI = null;
      debugLog('âš ï¸ AIæ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¾ã—ãŸï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ã¯æ­£å¸¸å‹•ä½œï¼‰');
    }
    
    debugLog('âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’å¾©å…ƒï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
    checkAndRestoreSession().catch(sessionError => {
      console.warn('âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒã§ã‚¨ãƒ©ãƒ¼ï¼ˆç¶™ç¶šå¯èƒ½ï¼‰:', sessionError);
    });
    
  } catch (error) {
    console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã›ãšã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿
    debugLog('åˆæœŸåŒ–ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚·ã‚¹ãƒ†ãƒ ã¯å‹•ä½œã—ã¾ã™');
    
    // 5ç§’å¾Œã«å†è©¦è¡Œ
    setTimeout(() => {
      console.log('ğŸ”„ åˆæœŸåŒ–ã‚’å†è©¦è¡Œã—ã¾ã™...');
      initializeApp();
    }, 5000);
  }
}

    // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«åˆæœŸåŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
    // ====================================
    // AI ãƒãƒ£ãƒƒãƒˆ UI åˆ¶å¾¡é–¢æ•°
    // ====================================
    
    let isAIChatOpen = false;
    
    // AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã®é–‹é–‰
    function toggleAIChat() {
      console.log('ğŸ¤– AIãƒãƒ£ãƒƒãƒˆåˆ‡ã‚Šæ›¿ãˆ');
      
      const panel = document.getElementById('aiChatPanel');
      
      if (isAIChatOpen) {
        closeAIChat();
      } else {
        openAIChat();
      }
    }
    
    // AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚’é–‹ã
    function openAIChat() {
      console.log('ğŸ“‚ AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚’é–‹ã');
      
      const panel = document.getElementById('aiChatPanel');
      panel.classList.add('active');
      isAIChatOpen = true;
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        const input = document.getElementById('aiInputField');
        if (input) input.focus();
      }, 400);
    }
    
    // AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
    function closeAIChat() {
      console.log('ğŸ“ AIãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹');
      
      const panel = document.getElementById('aiChatPanel');
      panel.classList.remove('active');
      isAIChatOpen = false;
    }
    
// AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    async function sendAIMessage() {
      const input = document.getElementById('aiInputField');
      const message = input.value.trim();
      
      if (!message || !stockEasyAI) return;
      
      console.log('ğŸ’¬ AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:', message);
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      addAIMessageToChat('user', message);
      
      // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      input.value = '';
      autoResizeAIInput(input);
      
      // AIå¿œç­”ã‚’ç”Ÿæˆ
      try {
        const response = await stockEasyAI.processMessage(message);
        addAIMessageToChat('ai', response);
      } catch (error) {
        console.error('AIå¿œç­”ã‚¨ãƒ©ãƒ¼:', error);
        addAIMessageToChat('ai', 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }
    
    // ãƒãƒ£ãƒƒãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    function addAIMessageToChat(sender, message) {
      const chatBody = document.getElementById('aiChatBody');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `ai-message ${sender}`;
      
      messageDiv.innerHTML = `
        <div class="ai-message-bubble">${message}</div>
      `;
      
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    
    // Enter ã‚­ãƒ¼é€ä¿¡å¯¾å¿œ
    function handleAIKeyPress(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendAIMessage();
      }
    }
    
    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ãƒªã‚µã‚¤ã‚º
    function autoResizeAIInput(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 80) + 'px';
    }
    
    // AIçŠ¶æ…‹æ›´æ–°
    function updateAIBadgeStatus(status) {
      const dot = document.getElementById('aiStatusDot');
      
      // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      dot.classList.remove('loading', 'error');
      
      // æ–°ã—ã„çŠ¶æ…‹ã‚’è¨­å®š
      if (status === 'loading') {
        dot.classList.add('loading');
      } else if (status === 'error') {
        dot.classList.add('error');
      }
      // 'ready' ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆç·‘ï¼‰
    }
    
    // ESCã‚­ãƒ¼ã§ãƒãƒ£ãƒƒãƒˆé–‰ã˜ã‚‹
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isAIChatOpen) {
        closeAIChat();
      }
    });
    
    // ãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('aiChatPanel');
      const badge = document.getElementById('aiBadge');
      
      if (isAIChatOpen && 
          !panel.contains(e.target) && 
          !badge.contains(e.target)) {
        closeAIChat();
      }
    });
    
    // AIãƒãƒƒã‚¸è¡¨ç¤ºåˆ¶å¾¡é–¢æ•°
    function showAIBadge() {
      console.log('ğŸ¤– AIãƒãƒƒã‚¸ã‚’è¡¨ç¤º');
      const badge = document.getElementById('aiBadge');
      if (badge) {
        badge.classList.add('show');
        
        // å°‘ã—é…ã‚Œã¦è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => {
          if (badge.style) {
            badge.style.transform = 'scale(1.1)';
            setTimeout(() => {
              badge.style.transform = 'scale(1)';
            }, 200);
          }
        }, 500);
      }
    }
    
    function hideAIBadge() {
      console.log('ğŸ¤– AIãƒãƒƒã‚¸ã‚’éè¡¨ç¤º');
      const badge = document.getElementById('aiBadge');
      if (badge) {
        badge.classList.remove('show');
        
        // ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒãƒ«ã‚‚ç¢ºå®Ÿã«é–‰ã˜ã‚‹
        if (isAIChatOpen) {
          closeAIChat();
        }
      }
    }
    
    console.log('âœ… AI Chat UI functions loaded');

// ====================================
// æ—¥æœ¬èªæ­£è¦åŒ–ã‚¨ãƒ³ã‚¸ãƒ³
// ====================================
class JapaneseNormalizer {
  constructor() {
    // è¡¨è¨˜ã‚†ã‚Œã®çµ±ä¸€ãƒãƒƒãƒ—
    this.normalizeMap = {
      // è»Šã„ã™é–¢é€£
      'ãã‚‹ã¾ã„ã™': 'è»Šã„ã™',
      'è»Šæ¤…å­': 'è»Šã„ã™', 
      'è»Šã‚¤ã‚¹': 'è»Šã„ã™',
      'ãã‚‹ã¾ã‚¤ã‚¹': 'è»Šã„ã™',
      'ãã‚‹ã¾æ¤…å­': 'è»Šã„ã™',
      'kurumaisu': 'è»Šã„ã™',
      
      // æ­©è¡Œå™¨é–¢é€£
      'ã»ã“ã†ã': 'æ­©è¡Œå™¨',
      'æ­©è¡Œæ°—': 'æ­©è¡Œå™¨',
      'æ­©è¡Œã': 'æ­©è¡Œå™¨',
      'hokouki': 'æ­©è¡Œå™¨',
      
      // ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼é–¢é€£
      'ã‚·ãƒ«ãƒãƒ¼': 'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼',
      'æ‰‹æŠ¼ã—è»Š': 'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼',
      'ã‚«ãƒ¼ãƒˆ': 'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼',
      'ã—ã‚‹ã°ãƒ¼ã‹ãƒ¼': 'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼',
      'siruba-ka-': 'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼',
      'silvercar': 'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼',
      
      
      // æ–é–¢é€£
      'ã¤ãˆ': 'æ–',
      'ãƒ„ã‚¨': 'æ–',
      'ã‚¹ãƒ†ãƒƒã‚­': 'æ–',
      'ã‚¹ãƒ†ã‚£ãƒƒã‚¯': 'æ–',
      'ã‚ˆã‚“ã¦ã‚“ã¥ãˆ': 'å››ç‚¹æ–',
      '4ç‚¹æ–': 'å››ç‚¹æ–',
      '4æœ¬æ–': 'å››ç‚¹æ–',
      'å››æœ¬æ–': 'å››ç‚¹æ–',
      'ã„ã£ã½ã‚“ã¥ãˆ': 'ä¸€æœ¬æ–',
      '1æœ¬æ–': 'ä¸€æœ¬æ–',
      
      // ã‚¨ã‚¢ãƒãƒƒãƒˆé–¢é€£
      'ã‚¨ã‚¢ãƒ¼ãƒãƒƒãƒˆ': 'ã‚¨ã‚¢ãƒãƒƒãƒˆ',
      'ãƒãƒƒãƒˆãƒ¬ã‚¹': 'ã‚¨ã‚¢ãƒãƒƒãƒˆ',
      
      // ç•¥èªãƒ»ä¿—èª
      'WC': 'è»Šã„ã™',
      'ãƒ›ã‚¤ãƒã‚§': 'è»Šã„ã™',
      'ã‚ã‚‹ã“ãƒ¼': 'æ­©è¡Œå™¨'
    };
    
    // åŠ©è©ãƒ»èªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³
    this.particlePattern = /[ã‚’ã®ãŒã«ã¸ã¨ã§ã‚‚ã€ã€‚ï¼ï¼Ÿ\s]+$/g;
  }
  
// ãƒ†ã‚­ã‚¹ãƒˆã‚’æ­£è¦åŒ–ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
  normalize(text) {
    if (!text) return '';
    
    let normalized = text.toLowerCase().trim();
    console.log('ğŸ” æ­£è¦åŒ–é–‹å§‹:', `"${text}" â†’ "${normalized}"`);
    
    // normalizeMapã®å†…å®¹ã‚’ç¢ºèª
    console.log('ğŸ“‹ normalizeMapç¢ºèª:', this.normalizeMap);
    
    // 1. è¡¨è¨˜ã‚†ã‚Œã®çµ±ä¸€ï¼ˆä¸€ã¤ãšã¤ç¢ºèªï¼‰
    for (const [variant, standard] of Object.entries(this.normalizeMap)) {
      const beforeReplace = normalized;
      
      // æ–‡å­—åˆ—ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (normalized.includes(variant.toLowerCase())) {
        console.log(`âš ï¸  ãƒãƒƒãƒç™ºè¦‹: "${variant}" ãŒ "${normalized}" ã«å«ã¾ã‚Œã¦ã„ã¾ã™`);
        
        const regex = new RegExp(variant.toLowerCase(), 'g');
        normalized = normalized.replace(regex, standard);
        
        console.log(`ğŸ”„ ç½®æ›å®Ÿè¡Œ: "${beforeReplace}" â†’ "${normalized}"`);
        
        // ç½®æ›ãŒè¡Œã‚ã‚ŒãŸå ´åˆã¯çµ‚äº†
        if (beforeReplace !== normalized) {
          console.log(`âœ… ç½®æ›å®Œäº†: æœ€çµ‚çµæœ "${normalized}"`);
          break;
        }
      }
    }
    
    // 2. åŠ©è©ãƒ»èªå°¾ã®é™¤å»
    const beforeParticle = normalized;
    normalized = normalized.replace(this.particlePattern, '');
    if (beforeParticle !== normalized) {
      console.log(`ğŸ§¹ åŠ©è©é™¤å»: "${beforeParticle}" â†’ "${normalized}"`);
    }
    
    // 3. ä½™åˆ†ãªç©ºç™½ã®é™¤å»
    const beforeSpace = normalized;
    normalized = normalized.replace(/\s+/g, ' ').trim();
    if (beforeSpace !== normalized) {
      console.log(`ğŸ§¹ ç©ºç™½é™¤å»: "${beforeSpace}" â†’ "${normalized}"`);
    }
    
    console.log('ğŸ¯ æ­£è¦åŒ–å®Œäº†:', `"${normalized}"`);
    return normalized;
  }
  
  // èªå¹¹æŠ½å‡ºï¼ˆã‚ˆã‚Šè©³ç´°ï¼‰
  extractStem(text) {
    const normalized = this.normalize(text);
    
    // ã•ã‚‰ã«ç´°ã‹ã„èªå°¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é™¤å»
    const patterns = [
      /ãã ã•ã„$/,
      /ãã‚Œã‚‹$/,
      /ã‚‚ã‚‰ãˆã‚‹$/,
      /ãŸã„$/,
      /ã»ã—ã„$/,
      /ã„ã‚‹$/,
      /ã‚ã‚‹$/,
      /ãªã„$/
    ];
    
    let stem = normalized;
    for (const pattern of patterns) {
      stem = stem.replace(pattern, '');
    }
    
    return stem.trim();
  }
}
    
// ====================================
// StockEasy AIå‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³ - Stage 2
// ====================================

// 1. æ„å›³è§£æã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆæ­£è¦åŒ–å¯¾å¿œç‰ˆï¼‰
class IntentAnalyzer {
  constructor() {
    // æ—¥æœ¬èªæ­£è¦åŒ–ã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–
    this.normalizer = new JapaneseNormalizer();
    
    // å‚™å“ç®¡ç†ç‰¹åŒ–ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³
    this.patterns = {
      // åœ¨åº«ç¢ºèªãƒ»è²¸å‡ºè¦æ±‚
      stock_check: [
        /(.+)ã®åœ¨åº«/, /(.+)ã¯ã‚ã‚‹/, /(.+)ã©ã“/, /(.+)ã®çŠ¶æ…‹/,
        /åœ¨åº«ç¢ºèª/, /ã©ã“ã«ã‚ã‚‹/, /çŠ¶æ³æ•™ãˆã¦/,
        // å¤šæ§˜ãªè¦æ±‚ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
        /(.+)ç©ºã„ã¦ã‚‹/, /(.+)ã‚ã‚‹ï¼Ÿ/, /(.+)ã©ã“ï¼Ÿ/, /(.+)ã€è²¸ã—ã¦/, /(.+)è²¸ã—ã¦ã‚‚ã‚‰ãˆã‚‹ï¼Ÿ/,
        /(.+)ä½¿ã„ãŸã„/, /(.+)ä½¿ã‚ã›ã¦/, /(.+)ã€å¿…è¦ãªã‚“ã ã‘ã©/, /(.+)ãŒå¿…è¦ã§ã™/, /(.+)æ¬²ã—ã„/,
        /(.+)ã‚’ãŠé¡˜ã„/, /(.+)é ¼ã‚€ã‚/, /(.+)ã¡ã‚‡ã†ã ã„/, /(.+)ã€ã‚ã‚‹ã¨ã†ã‚Œã—ã„ã‚“ã ã‘ã©/,
        /(.+)ã€ã©ã£ã‹ã«ã‚ã‚‹ï¼Ÿ/, /(.+)ã€æ‰‹é…ã—ã¦ã‚‚ã‚‰ãˆã‚‹ï¼Ÿ/, /(.+)ã€ä½¿ãˆã¾ã™ã‹ï¼Ÿ/, /(.+)å‡ºã—ã¦ãã‚Œã‚‹ï¼Ÿ/,
        /(.+)ãŠé¡˜ã„ã§ãã¾ã™ã‹ï¼Ÿ/, /(.+)ã€ç©ºã„ã¦ãŸã‚‰è²¸ã—ã¦/, /ç©ºã„ã¦ã‚‹(.+)ã€ã‚ã‚‹ï¼Ÿ/, /ç©º(.+)ã€ä»Šã©ã“ï¼Ÿ/,
        /(.+)æŒã£ã¦ãã¦/, /(.+)å‘¼ã‚“ã§/, /(.+)æº–å‚™ã—ã¦/, /(.+)ã€ã¡ã‚‡ã£ã¨ã„ã‚‹/, /(.+)æ¢ã—ã¦/,
        /(.+)ã‚ã£ãŸã‚‰åŠ©ã‹ã‚‹ã‚“ã ã‘ã©/, /(.+)å€Ÿã‚ŠãŸã„/, /(.+)ã€ä¸€å°ã»ã—ã„/, /(.+)ä»Šä½¿ãˆã‚‹ï¼Ÿ/,
        /(.+)ã€ä»Šæ‰‹å…ƒã«ã‚ã‚‹ï¼Ÿ/, /(.+)ãŠé¡˜ã„ã­/, /(.+)ã‚ˆã‚ã—ã/, /(.+)ã™ãä½¿ã„ãŸã„/,
        // å˜èªã®ã¿ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
        /^(.+)$/ // æœ€å¾Œã«è¿½åŠ ï¼šå˜ä¸€å˜èªã‚‚ã‚­ãƒ£ãƒƒãƒ
      ],
      
      // ç‰¹å®šå‚™å“ã®ç¢ºèª
      item_status: [
        /([A-Z]+\d+)/, // IDå½¢å¼ (WC001ãªã©)
        /([A-Z]+\d+)ã®çŠ¶æ…‹/, /([A-Z]+\d+)ã©ã“/
      ],
      
      // è²¸å‡ºé–¢é€£
      borrow: [
        /å€Ÿã‚ŠãŸã„/, /è²¸ã—å‡ºã—/, /ä½¿ã„ãŸã„/, /è²¸å‡ºæ–¹æ³•/
      ],
      
      // è¿”å´é–¢é€£
      return: [
        /è¿”å´/, /æˆ»ã—ãŸã„/, /è¿”ã—ãŸã„/, /è¿”å´æ–¹æ³•/, /(.+)è¿”å´ã—ãŸã„/, /(.+)ã‚’è¿”å´ã—ãŸã„/
      ],
      
      // ä¸€èˆ¬çš„ãªæŒ¨æ‹¶ãƒ»è³ªå•
      greeting: [
        /ã“ã‚“ã«ã¡ã¯/, /ã¯ã˜ã‚ã¾ã—ã¦/, /ã‚ˆã‚ã—ã/, /ã‚ã‚ŠãŒã¨ã†/, /ãŠã¯ã‚ˆã†/, /ã“ã‚“ã°ã‚“ã¯/
      ],
      
      // ãƒ˜ãƒ«ãƒ—ãƒ»ä½¿ã„æ–¹
      help: [
        /ä½¿ã„æ–¹/, /ãƒ˜ãƒ«ãƒ—/, /ä½•ãŒã§ãã‚‹/, /æ©Ÿèƒ½/, /æ“ä½œæ–¹æ³•/, /æ“ä½œã‚’æ•™ãˆã¦/, /æ“ä½œæ•™ãˆã¦/,
        /æ•™ãˆã¦ã»ã—ã„/, /æ“ä½œã‚’æ•™ãˆã¦ã»ã—ã„/
      ]
    };
  }
  
  analyze(text) {
    const result = {
      intent: 'unknown',
      entities: {},
      confidence: 0,
      originalText: text
    };
    
    // ğŸ”¥ é‡è¦ï¼šãƒ†ã‚­ã‚¹ãƒˆã‚’æ­£è¦åŒ–ã—ã¦ã‹ã‚‰è§£æ
    const normalizedText = this.normalizer.normalize(text);
    console.log('æ­£è¦åŒ–å‰:', text);
    console.log('æ­£è¦åŒ–å¾Œ:', normalizedText);
    
    // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
    for (const [intent, patterns] of Object.entries(this.patterns)) {
      for (const pattern of patterns) {
        // æ­£è¦åŒ–ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã§ãƒãƒƒãƒãƒ³ã‚°
        const match = normalizedText.match(pattern);
        if (match) {
          result.intent = intent;
          result.confidence = 0.8;
          
          // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡º
          if (match[1]) {
            if (intent === 'stock_check') {
              // æ­£è¦åŒ–ã•ã‚ŒãŸå‚™å“åã‚’ä½¿ç”¨
              let itemName = match[1];
              // ã•ã‚‰ã«èªå¹¹ã‚’æŠ½å‡º
              itemName = this.normalizer.extractStem(itemName);
              result.entities.item_name = itemName;
            } else if (intent === 'item_status') {
              result.entities.item_id = match[1];
            }
          }
          
          console.log('è§£æçµæœ:', result);
          return result;
        }
      }
    }
    
    return result;
  }
}

// ====================================
// æ›–æ˜§æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³
// ====================================

class FuzzySearchEngine {
  constructor() {
    // å‚™å“ã‚«ãƒ†ã‚´ãƒªã®ä»£è¡¨çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    this.categoryKeywords = {
      'è»Šã„ã™': ['è»Šã„ã™', 'ãã‚‹ã¾ã„ã™', 'è»Šæ¤…å­', 'è»Šã‚¤ã‚¹', 'ãã‚‹ã¾æ¤…å­', 'ãã‚‹ã¾ã‚¤ã‚¹', 'è»Š'],
      'æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼': ['æ­©è¡Œå™¨', 'ã»ã“ã†ã', 'ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼', 'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼', 'æ‰‹æŠ¼ã—è»Š', 'ã‚«ãƒ¼ãƒˆ'],
      'æ–': ['æ–', 'ã¤ãˆ', 'ã‚¹ãƒ†ãƒƒã‚­', 'ã‚¹ãƒ†ã‚£ãƒƒã‚¯', 'å››ç‚¹æ–', 'ä¸€æœ¬æ–'],
      'ã‚¨ã‚¢ãƒãƒƒãƒˆ': ['ã‚¨ã‚¢ãƒãƒƒãƒˆ', 'ã‚¨ã‚¢ãƒ¼ãƒãƒƒãƒˆ', 'ãƒãƒƒãƒˆ', 'ãƒãƒƒãƒˆãƒ¬ã‚¹'],
      'ãã®ä»–': ['ãã®ä»–', 'ãã®ãŸ']
    };
  }
  
  // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã‚’è¨ˆç®—
  calculateDistance(str1, str2) {
    const matrix = [];
    
    // åˆæœŸåŒ–
    for (let i = 0; i <= str2.length; i++) {
      matrix[i] = [i];
    }
    for (let j = 0; j <= str1.length; j++) {
      matrix[0][j] = j;
    }
    
    // å‹•çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
    for (let i = 1; i <= str2.length; i++) {
      for (let j = 1; j <= str1.length; j++) {
        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1];
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1, // ç½®æ›
            matrix[i][j - 1] + 1,     // æŒ¿å…¥
            matrix[i - 1][j] + 1      // å‰Šé™¤
          );
        }
      }
    }
    
    return matrix[str2.length][str1.length];
  }
  
  // é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ï¼ˆ0-1ã®ç¯„å›²ï¼‰
  calculateSimilarity(query, target) {
    const distance = this.calculateDistance(query.toLowerCase(), target.toLowerCase());
    const maxLength = Math.max(query.length, target.length);
    return maxLength === 0 ? 1 : 1 - (distance / maxLength);
  }
  
  // å‚™å“åã§ã®æ›–æ˜§æ¤œç´¢
  searchByName(query, items, threshold = 0.6) {
    const results = [];
    
    for (const item of items) {
      const similarity = this.calculateSimilarity(query, item.name);
      if (similarity >= threshold) {
        results.push({
          item: item,
          similarity: similarity,
          matchType: 'name'
        });
      }
    }
    
    return results.sort((a, b) => b.similarity - a.similarity);
  }
  
  // ã‚«ãƒ†ã‚´ãƒªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®æ›–æ˜§æ¤œç´¢
  searchByCategory(query, items, threshold = 0.5) {
    const results = [];
    
    for (const [category, keywords] of Object.entries(this.categoryKeywords)) {
      for (const keyword of keywords) {
        const similarity = this.calculateSimilarity(query, keyword);
        if (similarity >= threshold) {
          // ã“ã®ã‚«ãƒ†ã‚´ãƒªã®å‚™å“ã‚’æ¤œç´¢
          const categoryItems = items.filter(item => item.category === category);
          for (const item of categoryItems) {
            results.push({
              item: item,
              similarity: similarity,
              matchType: 'category',
              matchedKeyword: keyword
            });
          }
          break; // ä¸€ã¤ãƒãƒƒãƒã—ãŸã‚‰ãã®ã‚«ãƒ†ã‚´ãƒªã¯çµ‚äº†
        }
      }
    }
    
    return results.sort((a, b) => b.similarity - a.similarity);
  }
  
  // çµ±åˆæ¤œç´¢ï¼ˆåå‰ + ã‚«ãƒ†ã‚´ãƒªï¼‰
  search(query, items, nameThreshold = 0.6, categoryThreshold = 0.5) {
    const nameResults = this.searchByName(query, items, nameThreshold);
    const categoryResults = this.searchByCategory(query, items, categoryThreshold);
    
    // çµæœã‚’ãƒãƒ¼ã‚¸ã—ã¦é‡è¤‡ã‚’é™¤å»
    const allResults = [...nameResults, ...categoryResults];
    const uniqueResults = [];
    const seenIds = new Set();
    
    for (const result of allResults) {
      if (!seenIds.has(result.item.id)) {
        seenIds.add(result.item.id);
        uniqueResults.push(result);
      }
    }
    
    return uniqueResults.sort((a, b) => b.similarity - a.similarity);
  }
}

// 2. å¿œç­”ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³
class ResponseGenerator {
  constructor() {
    this.aliases = {
      'è»Šã„ã™': ['è»Šæ¤…å­', 'ãã‚‹ã¾ã„ã™', 'è»Šã‚¤ã‚¹', 'ãƒã‚§ã‚¢'],
      'æ­©è¡Œå™¨': ['ã‚¦ã‚©ãƒ¼ã‚«ãƒ¼', 'ã‚ã‚‹ã“ã†ã'],
      'ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼': ['æ‰‹æŠ¼ã—è»Š', 'ã‚«ãƒ¼ãƒˆ', 'ãƒ¯ã‚´ãƒ³'],
      'æ–': ['ã¤ãˆ', 'ã‚¹ãƒ†ãƒƒã‚­', 'ã‚¹ãƒ†ã‚£ãƒƒã‚¯', 'ãƒ„ã‚¨'],
      'å››ç‚¹æ–': ['4ç‚¹æ–', 'å››æœ¬æ–', '4æœ¬æ–'],
      'ä¸€æœ¬æ–': ['1æœ¬æ–', 'æ™®é€šã®æ–', 'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆæ–'],
      'ã‚¨ã‚¢ãƒãƒƒãƒˆ': ['ã‚¨ã‚¢ãƒ¼ãƒãƒƒãƒˆ', 'ãƒãƒƒãƒˆãƒ¬ã‚¹', 'ãƒãƒƒãƒˆ'],
      'ä½“åœ§åˆ†æ•£': ['ä½“åœ§', 'è¤¥ç˜¡äºˆé˜²', 'ã˜ã‚‡ããã†']
    };
  }
  
 findEquipmentByName(searchTerm) {
    const normalizedSearch = searchTerm.toLowerCase();
    
    // 1. å®Œå…¨ä¸€è‡´æ¤œç´¢ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    let matches = items.filter(item => 
      item.name && item.name.toLowerCase().includes(normalizedSearch)
    );
    
    // 2. åˆ¥åãƒ»åŒç¾©èªã§ã®æ¤œç´¢ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    if (matches.length === 0) {
      for (const [mainName, aliases] of Object.entries(this.aliases)) {
        if (aliases.some(alias => 
          alias.toLowerCase().includes(normalizedSearch) || 
          normalizedSearch.includes(alias.toLowerCase())
        )) {
          const mainMatches = items.filter(item => 
            item.name && item.name.toLowerCase().includes(mainName.toLowerCase())
          );
          matches = matches.concat(mainMatches);
        }
        
        if (mainName.toLowerCase().includes(normalizedSearch) || 
            normalizedSearch.includes(mainName.toLowerCase())) {
          const mainMatches = items.filter(item => 
            item.name && item.name.toLowerCase().includes(mainName.toLowerCase())
          );
          matches = matches.concat(mainMatches);
        }
      }
    }
    
    // 3. ã‚«ãƒ†ã‚´ãƒªã§ã®æ¤œç´¢ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    if (matches.length === 0) {
      matches = items.filter(item => 
        item.category && item.category.toLowerCase().includes(normalizedSearch)
      );
    }
    
    // ğŸ”¥ 4. æ›–æ˜§æ¤œç´¢ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
    if (matches.length === 0) {
      console.log('æ›–æ˜§æ¤œç´¢ã‚’å®Ÿè¡Œ:', searchTerm);
      const fuzzyResults = this.fuzzyEngine.search(searchTerm, items);
      matches = fuzzyResults.map(result => result.item);
      
      if (fuzzyResults.length > 0) {
        console.log('æ›–æ˜§æ¤œç´¢çµæœ:', fuzzyResults);
      }
    }
    
    // é‡è¤‡ã‚’é™¤å»
    const uniqueMatches = matches.filter((item, index, self) => 
      index === self.findIndex(i => i.id === item.id)
    );
    
    return uniqueMatches;
  }
  
  generate(intentResult) {
    const { intent, entities } = intentResult;
    
    switch (intent) {
      case 'stock_check':
        return this.handleStockCheck(entities);
      case 'item_status':
        return this.handleItemStatus(entities);
      case 'borrow':
        return this.handleBorrowInquiry();
      case 'return':
        return this.handleReturnInquiry();
      case 'greeting':
        return this.handleGreeting();
      case 'help':
        return this.handleHelp();
      default:
        return this.handleUnknown(intentResult);
    }
  }
  
  handleStockCheck(entities) {
    const itemName = entities.item_name;
    
    if (!itemName) {
      return "ã©ã®å‚™å“ã‚’ãŠæ¢ã—ã§ã™ã‹ï¼Ÿ<br>ä¾‹ï¼šã€Œè»Šã„ã™ã®åœ¨åº«ã¯ï¼Ÿã€ã€Œæ–ã‚ã‚‹ï¼Ÿã€";
    }
    
    const matchingItems = this.findEquipmentByName(itemName);
    
    if (matchingItems.length === 0) {
      return `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã€Œ${itemName}ã€ã«è©²å½“ã™ã‚‹å‚™å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br><br>` +
             `ğŸ“‹ ç¾åœ¨ç®¡ç†ã—ã¦ã„ã‚‹å‚™å“ï¼š<br>` +
             `â€¢ è»Šã„ã™ï¼ˆè‡ªèµ°å¼ãƒ»ä»‹åŠ©å¼ï¼‰<br>` +
             `â€¢ æ­©è¡Œå™¨ãƒ»ã‚·ãƒ«ãƒãƒ¼ã‚«ãƒ¼<br>` +
             `â€¢ æ–ï¼ˆå››ç‚¹æ–ãƒ»ä¸€æœ¬æ–ï¼‰<br>` +
             `â€¢ ã‚¨ã‚¢ãƒãƒƒãƒˆ<br><br>` +
             `ğŸ’¡ ã€Œè»Šã„ã™ã€ã€Œæ–ã€ã€Œæ­©è¡Œå™¨ã€ãªã©ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„`;
    }
    
    let response = `ğŸ“‹ ${itemName}ã®æ¤œç´¢çµæœï¼š<br><br>`;
    
    matchingItems.forEach(item => {
      const statusIcon = item.status === 'å¾…æ©Ÿ' ? 'âœ…' : 'â°';
      const locationInfo = item.status === 'å¾…æ©Ÿ' ? 
        `ä¿ç®¡å ´æ‰€ï¼š${item.location}` : 
        `ç¾åœ¨åœ°ï¼š${item.current}ï¼ˆä½¿ç”¨ä¸­ï¼‰`;
        
      response += `${statusIcon} ${item.name} (${item.id})<br>`;
      response += `ã€€${locationInfo}<br><br>`;
    });
    
    const availableCount = matchingItems.filter(item => item.status === 'å¾…æ©Ÿ').length;
    response += `ğŸ’¡ åˆ©ç”¨å¯èƒ½ï¼š${availableCount}ä»¶ / å…¨${matchingItems.length}ä»¶`;
    
    return response;
  }
  
  handleItemStatus(entities) {
    const itemId = entities.item_id;
    
    if (!itemId) {
      return "å‚™å“IDã‚’æ•™ãˆã¦ãã ã•ã„ã€‚<br>ä¾‹ï¼šã€ŒWC001ã®çŠ¶æ…‹ã¯ï¼Ÿã€";
    }
    
    const item = items.find(i => i.id === itemId.toUpperCase());
    
    if (!item) {
      return `å‚™å“IDã€Œ${itemId}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br><br>ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å‚™å“ï¼š<br>${items.map(i => `â€¢ ${i.id}: ${i.name}`).join('<br>')}`;
    }
    
    const statusIcon = item.status === 'å¾…æ©Ÿ' ? 'âœ…' : 'â°';
    const statusDetail = item.status === 'å¾…æ©Ÿ' ? 
      'åˆ©ç”¨å¯èƒ½ã§ã™' : 
      `${item.user}ã§ä½¿ç”¨ä¸­ã§ã™`;
    
    return `ğŸ“¦ ${item.name} (${item.id})<br><br>` +
           `${statusIcon} çŠ¶æ…‹ï¼š${item.status}<br>` +
           `ğŸ“ ç¾åœ¨åœ°ï¼š${item.current}<br>` +
           `ğŸ  ä¿ç®¡å ´æ‰€ï¼š${item.location}<br><br>` +
           `ğŸ’¡ ${statusDetail}`;
  }
  
  handleBorrowInquiry() {
    return `ğŸ“‹ å‚™å“ã®å€Ÿç”¨æ–¹æ³•ï¼š<br><br>` +
           `1ï¸âƒ£ å€Ÿã‚ŠãŸã„å‚™å“ã‚’æ¢ã™<br>` +
           `ã€€ã€Œè»Šã„ã™ã®åœ¨åº«ã¯ï¼Ÿã€ã¨èã„ã¦ãã ã•ã„<br><br>` +
           `2ï¸âƒ£ ã€Œå€Ÿç”¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯<br>` +
           `ã€€å‚™å“ä¸€è¦§ã‹ã‚‰æ“ä½œã§ãã¾ã™<br><br>` +
           `3ï¸âƒ£ ä½¿ç”¨å ´æ‰€ã‚’é¸æŠ<br>` +
           `ã€€äº‹å‹™æ‰€ã€1Fã€2Fã€3Fã€4Fã€5Fã€åœ°åŸŸäº¤æµå®¤ã€æ©Ÿèƒ½è¨“ç·´å®¤<br><br>` +
           `ğŸ’¡ ä½•ã‹ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ãŠèã‹ã›ãã ã•ã„ï¼`;
  }
  
  handleReturnInquiry() {
    return `ğŸ“‹ å‚™å“ã®è¿”å´æ–¹æ³•ï¼š<br><br>` +
           `1ï¸âƒ£ ã€Œè¿”å´ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯<br>` +
           `ã€€å‚™å“ä¸€è¦§ã‹ã‚‰æ“ä½œã§ãã¾ã™<br><br>` +
           `2ï¸âƒ£ è¿”å´å ´æ‰€ã‚’é¸æŠ<br>` +
           `ã€€æ¨å¥¨å ´æ‰€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™<br><br>` +
           `3ï¸âƒ£ ã€Œæ±ºå®šã€ã§å®Œäº†<br>` +
           `ã€€è‡ªå‹•çš„ã«çŠ¶æ…‹ãŒã€Œå¾…æ©Ÿã€ã«å¤‰ã‚ã‚Šã¾ã™<br><br>` +
           `ğŸ’¡ æ¨å¥¨å ´æ‰€ã«è¿”å´ã„ãŸã ãã¨ã€æ¬¡ã®æ–¹ãŒè¦‹ã¤ã‘ã‚„ã™ããªã‚Šã¾ã™ï¼`;
  }
  
  handleGreeting() {
    const greetings = [
      "ã“ã‚“ã«ã¡ã¯ï¼å‚™å“ç®¡ç†ã®ãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã™ğŸ¤–",
      "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼ä½•ã‹ãŠæ¢ã—ã§ã™ã‹ï¼Ÿ",
      "ãŠç–²ã‚Œã•ã¾ã§ã™ï¼å‚™å“ã®ã“ã¨ãªã‚‰ä½•ã§ã‚‚ãŠèããã ã•ã„ï¼"
    ];
    
    const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
    
    return `${randomGreeting}<br><br>` +
           `ğŸ’¡ ã“ã‚“ãªã“ã¨ãŒã§ãã¾ã™ï¼š<br>` +
           `â€¢ ã€Œç©ºã„ã¦ã‚‹è»Šã„ã™ã‚ã‚‹ï¼Ÿã€- åœ¨åº«ç¢ºèª<br>` +
           `â€¢ ã€Œæ­©è¡Œå™¨ã‚’è¿”å´ã—ãŸã„ã€- è¿”å´å‡¦ç†<br>` +
           `â€¢ ã€Œæ“ä½œã‚’æ•™ãˆã¦ã»ã—ã„ã€- æ“ä½œèª¬æ˜`;
  }
  
  handleHelp() {
    return `ğŸ¤– StockEasy AI ã§ã§ãã‚‹ã“ã¨ï¼š<br><br>` +
           `ğŸ“¦ <strong>åœ¨åº«ç¢ºèª</strong><br>` +
           `ã€€ã€Œç©ºã„ã¦ã‚‹è»Šã„ã™ã‚ã‚‹ï¼Ÿã€<br>` +
           `ã€€ã€Œæ­©è¡Œå™¨ã¯ã‚ã‚‹ï¼Ÿã€<br><br>` +
           `ğŸ” <strong>å€‹åˆ¥ç¢ºèª</strong><br>` +
           `ã€€ã€ŒWC001ã®çŠ¶æ…‹ã¯ï¼Ÿã€<br>` +
           `ã€€ã€ŒWK001ã©ã“ï¼Ÿã€<br><br>` +
           `ğŸ“‹ <strong>æ“ä½œèª¬æ˜</strong><br>` +
           `ã€€ã€Œå€Ÿç”¨æ–¹æ³•ã¯ï¼Ÿã€<br>` +
           `ã€€ã€Œè¿”å´æ–¹æ³•ã¯ï¼Ÿã€<br><br>` +
           `ğŸ’¬ ãŠæ°—è»½ã«è©±ã—ã‹ã‘ã¦ãã ã•ã„ï¼`;
  }
  
  handleUnknown(intentResult) {
    return `ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚ˆãç†è§£ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ğŸ¤”<br><br>` +
           `ğŸ’¡ ã“ã‚“ãªæ„Ÿã˜ã§è©±ã—ã‹ã‘ã¦ã¿ã¦ãã ã•ã„ï¼š<br>` +
           `â€¢ ã€Œç©ºã„ã¦ã‚‹è»Šã„ã™ã‚ã‚‹ï¼Ÿã€<br>` +
           `â€¢ ã€ŒWC001ã®çŠ¶æ…‹ã¯ï¼Ÿã€<br>` +
           `â€¢ ã€Œæ“ä½œã‚’æ•™ãˆã¦ã»ã—ã„ã€<br><br>` +
           `<em>å…¥åŠ›å†…å®¹ï¼šã€Œ${intentResult.originalText}ã€</em>`;
  }
}

// 3. ãƒ¡ã‚¤ãƒ³AIã‚¨ãƒ³ã‚¸ãƒ³
class StockEasyAI {
  constructor() {
    this.intentAnalyzer = new IntentAnalyzer();
    this.responseGenerator = new ResponseGenerator();
    this.isProcessing = false;
  }
  
  async processMessage(message) {
    if (this.isProcessing) {
      return "å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...";
    }
    
    this.isProcessing = true;
    updateAIBadgeStatus('loading');
    
    try {
      // 1. æ„å›³è§£æ
      await this.delay(300);
      const intentResult = this.intentAnalyzer.analyze(message);
      
      // 2. å¿œç­”ç”Ÿæˆ
      await this.delay(200);
      const response = this.responseGenerator.generate(intentResult);
      
      updateAIBadgeStatus('ready');
      return response;
      
    } catch (error) {
      console.error('AIå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      updateAIBadgeStatus('error');
      return "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    } finally {
      this.isProcessing = false;
    }
  }
  
  delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

// AIã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
let stockEasyAI = null;
  </script>
</body>
</html>
